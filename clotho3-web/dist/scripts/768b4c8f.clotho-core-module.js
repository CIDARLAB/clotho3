var $clotho=window.$clotho=window.$clotho||{};angular.module("clotho.core",["clotho.angularAdditions"]),angular.module("clotho.angularAdditions",[]).config(function(){var a={};a.isEmpty=function(a){if(angular.isNumber(a))return a!==a;if(a===!0||a===!1)return!1;if(angular.isObject(a)){if(0===a.length)return!0;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}return angular.isUndefined(a)||null===a||0==a.length?!0:!1},a.isScope=function(a){return!!a&&angular.isFunction(a.$evalAsync)&&angular.isFunction(a.$watch)},a.once=function(a){var b,c;if(!angular.isFunction(a))throw new TypeError;return function(){return b?c:(b=!0,c=a.apply(this,arguments),a=null,c)}},a.remove=function(a,b,c){var d=-1,e=a?a.length:0,f=[];for(c=c||null;++d<e;){var g=a[d];(angular.isUndefined(g)||b.call(c,g,d,a))&&(angular.isDefined(g)&&f.push(g),a.splice(d--,1),e--)}return f},a.map=function(a,b,c){var d=angular.isArray(a)?[]:{};return angular.forEach(a,function(a,e,f){angular.isFunction(b)&&(angular.isArray(d)?d.push(b.call(c,a,e,f)):d[e]=b.call(c,a,e,f))}),d},angular.extend(angular,a)}).run(["$rootScope",function(a){a.$safeApply=function(){var a,b,c=!1;if(1==arguments.length){var d=arguments[0];"function"==typeof d?b=d:a=d}else a=arguments[0],b=arguments[1],3==arguments.length&&(c=!!arguments[2]);a=a||this,b=b||function(){},c||!a.$$phase?a.$apply?a.$apply(b):a.apply(b):b()}}]),angular.module("clotho.core").service("ClothoAuth",["PubSub","Debug","$q",function(a,b,c){function d(){return i}function e(){return j}function f(){return angular.copy(k)}function g(a){angular.forEach(l,function(b){b.call(null,a,d())})}var h=new b("ClothoAuth","#EE3333"),i=null,j=null,k=null,l=[],m=[];return a.on("auth:login",function(a){for(h.log("login event info:",a),i=a.primaryEmail,k=a.credentials;m.length>0;){var b=m.pop();b.resolve(d())}g("login")}),a.on("auth:logout",function(a){h.log("logout",a),i=null,k=null,g("logout")}),a.on("auth:error",function(){g("error")}),{isLoggedIn:function(){return!angular.isEmpty(i)},getUserId:d,getToken:e,getCredentials:f,onLogin:function(){if(!angular.isDefined(i)){var a=c.defer();return m.push(a),a.promise}c.when(d())},addStateListener:function(b,c){return(angular.isEmpty(b)||"all"===b)&&(b="auth:login auth:logout auth:error"),a.on(b,c)}}}]),angular.module("clotho.core").factory("Debug",["$log","$window","$filter",function(a,b,c){function d(a){return f===!0?!1:g.indexOf(a)<0}var e=!1,f=!1,g=[],h={};return function(f,g){f=angular.isString(f)?f:"ANONYMOUS",g=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(g)?g:"#"+Math.floor(16777215*Math.random()).toString(16),h[f]=[];var i={};return angular.forEach(["log","warn","error","debug","info"],function(b){i[b]=function(){var i=(new Error).stack;angular.isDefined(i)&&(i=i.split("\n"),0===i[0].indexOf("Error")&&(i=i.slice(1)),i=i.slice(1));var j=new Date,k=c("date")(j,"hh:mm:ss.sss");h[f].push({message:arguments,time:j.valueOf()}),d(f)&&(a[b].apply(null,["%c"+k+" - %O - "+f+"	","color: "+g+";",i].concat(Array.prototype.slice.call(arguments,0))),e&&console.trace())}}),angular.forEach(["table"],function(a){i[a]=b.console[a]}),i.object=function(b){h[f].push({message:b,time:Date.now().valueOf()}),angular.isObject(b)?a.log("%c"+JSON.stringify(b,null,2),"color: "+g+";"):a.log("%c"+b,"color: "+g+";")},i.group=function(a){angular.isDefined(b.console.group)&&b.console.group("%c"+f+"	"+a||"Collapsing Output","color: "+g+";")},i.groupCollapsed=function(a){angular.isDefined(b.console.groupCollapsed)&&b.console.groupCollapsed("%c"+f+"	"+a||"Collapsing Output","color: "+g+";")},i.groupEnd=function(){angular.isDefined(b.console.groupEnd)&&b.console.groupEnd()},i.$log=a,i.console=b.console||{},i}}]),angular.module("clotho.core").service("Clotho",["Socket","Communicator","Collector","PubSub","Debug","$window","$q","$rootScope","$location","$timeout",function(a,b,c,d,e,f,g,h,i,j){function k(){function a(){var a=g.defer();return a.reject(null),a.promise}var f=new e("ClothoAPI","#cc5555"),h={};h.send=b.send,h.pack=function(a,b,c,d){return{channel:a,data:b,requestId:c,options:d}},h.emit=function(a,b,c,d){return h.send(h.pack(a,b,c,d))};var k=new function(){var a=0;this.next=function(){return a+=1,a.toString()}};h.emitSubCallback=function(a,b,c,e){var f=g.defer(),i=Date.now().toString()+k.next();angular.isFunction(c)||(c=angular.noop);var l=j(function(){f.reject(null)},5e3);d.once(a+":"+i,function(a){j.cancel(l),angular.isUndefined(a)?f.reject():f.resolve(a),c(a)},"$clotho");var m=h.emit(a,b,i,e);return m===!1&&(j.cancel(l),f.reject(null)),f.promise},h.emitSubOnce=function(a,b,c){return h.emitSubCallback(a,b,angular.noop,c)};var l=function(a,b){function c(a){a?d.trigger("auth:login",a):d.trigger("auth:error","Could not Login")}var e={username:a,credentials:b};return h.emitSubCallback("login",e,c)},m=function(){function a(a){a?d.trigger("auth:logout",null):d.trigger("auth:error","Could not Logout")}return h.emitSubCallback("logout","",a)},n=function(a,b){function c(){}var d={username:a,credentials:b};return h.emitSubCallback("createUser",d,c)},o=function(a,b){function c(){}var d={username:a,password:b};return h.emitSubCallback("updatePassword",d,c)},p=function(a,b){return q(a,b)},q=function(b,d){if(angular.isUndefined(b))return a();var e=c.retrieveModel(b);if(e)return g.when(e);var f=function(a){angular.isEmpty(a)||c.storeModel(b,a)};return h.emitSubCallback("get",b,f,d)},r=function(a){if(angular.isEmpty(a))return!1;var b=function(){c.storeModel(a.id,a)};return h.emitSubCallback("set",a,b)},s=function(a){return angular.isUndefined(a)?null:(null===a.id&&delete a.id,h.emitSubOnce("create",a))},t=function(b){if(angular.isUndefined(b))return a();var d=function(){c.removeModel(b)};return h.emitSubCallback("destroy",b,d)},u=function(a){i.path("/editor").search("id",a)},v=function(b){return angular.isEmpty(b)?a():h.emitSubOnce("validate",b)},w=function(a,b){var c={uuid:a,timestamp:b};return h.emitSubOnce("revert",c)},x=function(a,b,c){var d={object:a,schema:b};return h.emitSubOnce("convert",d,c)},y=function(a,b){var d=function(b){console.groupCollapsed("Query Results for: "+JSON.stringify(a));try{angular.forEach(b,function(a){c.storeModel(a.id,a)})}catch(d){f.warn("error saving all models",d)}console.groupEnd()};return h.emitSubCallback("query",a,d,b)},z=function(a,b){var c={query:a};return b=angular.extend({mute:!0},b),h.emitSubOnce("autocomplete",c,b)},A=function(a){return h.emitSubOnce("recent",a)},B=function(a,b){var c={query:a,association:b};return f.warn("learn is not fully implemented"),h.emitSubOnce("learn",c)},C=function(a,b,c){var d={id:a,args:b};return c=angular.isObject(c)?c:{},h.emitSubOnce("run",d,c)},D=function(a){return angular.isString(a)&&(a={query:a,tokens:[]}),h.emitSubOnce("submit",a)},E=function(a,b){var c={viewId:a,options:b};h.emit("show",c)},F=function(a){h.emit("log",a)},G=function(a,b){var c={userID:b||"",msg:a,timestamp:Date.now(),from:"client"};h.emit("say",c)},H=function(a){h.emit("notify",a)},I=function(a,b){var c={userID:b,msg:a};h.emit("alert",c)},J=function(a,b,c){return c="undefined"!=typeof c?c:null,d.on("update:"+a,function(){f.log("watch triggered for "+a),p(a,{mute:!0}).then(function(a){angular.isFunction(b)?b.apply(c,[a]):angular.extend(b,a)})},c)},K=function(a,b,c){c="undefined"!=typeof c?c:null,d.on(a,function(a){b(a)},c)},L=function(a,b){d.trigger(a,b)},M=function(a,b){h.emit(a,b||{})},N=function(a,b){h.emit("broadcast",h.pack(a,b))},O=function(){console.log("need to set up share")},P=function(a,b){i.path("/trail").search("id",a),angular.isDefined(b)&&i.search("position",b)};return{login:l,logout:m,createUser:n,updatePassword:o,get:p,set:r,create:s,destroy:t,edit:u,validate:v,revert:w,convert:x,query:y,autocomplete:z,recent:A,learn:B,run:C,submit:D,show:E,say:G,alert:I,notify:H,log:F,watch:J,listen:K,trigger:L,emit:M,broadcast:N,share:O,startTrail:P}}return f.$clotho.api?f.$clotho.api:f.$clotho.api=k()}]),angular.module("clotho.core").service("ClientAPI",["PubSub","Collector","Debug","ClothoCommandHistory","$q","$injector","$window","$templateCache","$http","$rootScope","$location","$document","$compile",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=new c("ClientAPI","#dd99dd");if(f.has("$clothoModal"))var o=f.get("$clothoModal");var p=function(a){var c=a,d=c.id||c.uuid||!1;b.storeModel(d,c)},q=function(b){a.trigger(b.channel,b.data)},r=function(a,b){if(a){var c=angular.element('<clotho-show id="'+a+'"></clotho-show>'),d=l[0].querySelector(b);d||(d=l[0].getElementById("clothoAppWidgets")),angular.element(d).append(m(c)(j))}},s=function(a,b){var c=angular.element(document.querySelector("#"+a));(angular.isFunction(b)?b:angular.noop).apply(null,c.remove())},t=function(a){n.info(a)},u=function(a){angular.isString(a.text)||(angular.isNumber(a.text)?a.text=parseInt(a.text):null===a.text?a.text="null":angular.isUndefined(a.text)?a.text="undefined":a.text===!0?a.text="true":a.text===!1&&(a.text="false"));var b={"class":"muted",from:"server",timestamp:Date.now().valueOf()};a=angular.extend({},b,a);var c={success:"success",warning:"warning",error:"danger",failure:"danger",normal:"success",muted:"muted",info:"info"};a.class=c[angular.lowercase(a.class)],d.addMessage(a)},v=function(a){angular.isDefined(o)&&o.create({title:"Clotho Alert",content:"'"+a+"'"})},w=function(a){angular.isDefined(o)&&o.create({title:"Clotho Alert",content:"'"+a+"'"})},x=function(b,c){a.trigger("revisions:"+b,c)},y=function(a){k.path(a)},z=function(a){f.has("$route")?k.path("/editor?id="+a):u({text:"Editor not available",from:"client","class":"error",channel:"edit"})},A=function(a){k.path("/trails/"+a)};return{collect:p,broadcast:q,log:t,say:u,alert:v,display:r,hide:s,help:w,revisions:x,changeUrl:y,edit:z,startTrail:A}}]),angular.module("clotho.core").service("clothoLocalStorage",["$window","PubSub","Debug","$document",function(a,b,c,d){function e(){function d(a,c){b.trigger("update",a),b.trigger("update:"+a,angular.copy(c))}var e=new c("clothoLocalStorage","#88cc88"),f=a.localStorage,g=JSON,h="clotho_",i=function(){try{if(f.setItem("test","7"),"7"===f.getItem("test"))return f.removeItem("test"),!0}catch(a){}return!1};e.log("localStorage support? "+i());var j=function(){for(var a=!1,b=0,c=f.length;c>b;++b){var d=f.key(b);angular.isString(d)&&d.substring(0,h.length)==h&&(f.removeItem(d),--b,--c,a=!0)}return a},k=function(a,b){if(angular.isEmpty(a))return null;var c=f.getItem(h+a);return angular.isEmpty(c)?angular.isDefined(b)?b:null:angular.isObject(c)?c:g.parse(c)},l=function(a){if(angular.isEmpty(a))return!1;var b=f.getItem(h+a);return angular.isDefined(b)&&!angular.isEmpty(b)},m=function(a){return angular.isEmpty(a)?!1:(f.removeItem(h+a),!0)},n=function(a,b){if(angular.isEmpty(a))return!1;if(angular.isEmpty(b))return!1;b=angular.isString(b)?b:g.stringify(b);try{f.setItem(h+a,b)}catch(c){e.warn("couldnt save "+a,c)}return!0},o=function(b){if(b||(b=a.event),!(b.key.indexOf(h)<0)){var c=b.key.replace(h,"")||"",f=k(c);e.log("handle_storage_event for "+c,f),d(c,f)}};return a.addEventListener?a.addEventListener("storage",o,!1):a.attachEvent("onstorage",o),{getPrefix:function(){return h},isSupported:i,clear:j,getItem:k,hasItem:l,removeItem:m,setItem:n}}return a.$clotho.$localStorage?a.$clotho.$localStorage:a.$clotho.$localStorage=e()}]),angular.module("clotho.core").service("Collector",["$window","clothoLocalStorage","PubSub","Debug",function(a,b,c,d){function e(){function a(a,b){c.trigger("update",a),c.trigger("update:"+a,angular.copy(b))}var e=new d("Collector","#55bb55"),f=function(a,c){b.setItem(a,c)},g=function(b,c,d){d||!angular.equals(i(b),c)?(e.log(b+" (saving)",c),f(b,c),a(b,c)):e.log(b+" (model unchanged)")},h=function(a){return angular.copy(i(a))},i=function(a){return b.hasItem(a)?b.getItem(a):!1},j=function(a){return b.hasItem(a)?(b.removeItem(a),!0):!1},k=function(){b.clear(),c.trigger("collector_reset")};return k(),{hasItem:b.hasItem,silentAddModel:f,storeModel:g,retrieveModel:h,retrieveRef:i,removeModel:j,clearStorage:k}}return a.$clotho.$collector?a.$clotho.$collector:a.$clotho.$collector=e()}]),angular.module("clotho.core").service("PubSub",["$window","$rootScope","$filter","Debug",function(a,b,c,d){function e(){function a(a){return a?"all"==a?Object.keys(k):a.split(l):[]}function e(a){return k.hasOwnProperty(a)}function f(a){return e(a)&&k[a].length>0}function g(a,b,c,d){return angular.isFunction(a)?{callback:a,ref:b||null,priority:parseInt(c)||100,once:1==d}:null}function h(a,b){if(b&&!angular.isEmpty(b)){k[a]||(k[a]=[]);var c=b.ref;return angular.isScope(c)&&c.$on("$destroy",function(){t(j(c))}),k[a].push(b),angular.once(function(){i(a,b)})}return angular.noop}function i(a,b){var c=angular.remove(k[a],function(a){return angular.equals(a,b)});return c.length>0}function j(a){return angular.isScope(a)?a.$id:a}var k={},l=/\s+/,m=new d("PubSub","#55cccc"),n=function(){m.log("LISTENERS:"),angular.forEach(k,function(a,b){m.log(b),m.table(k[b])})},o=function(d,e){e=angular.isUndefined(e)?null:[e],angular.forEach(a(d),function(a){m.log("Publish on "+a,e),f(a)&&angular.forEach(c("orderBy")(k[a],"priority"),function(c,d){b.$safeApply(function(){c.callback.apply(c.ref,e)}),1==c.once&&k[a].splice(d,1)})})},p=function(c){angular.forEach(a(c),function(a){m.log("Reject on "+a),angular.forEach(k[a],function(c,d){b.$safeApply(function(){c.callback.apply(c.ref,null)}),1==c.once&&k[a].splice(d,1)})})},q=function(b,c,d,e,f){if(d=d||null,f=1==f,!angular.isFunction(c))return angular.noop;f&&(c=angular.once(c));var i=[];return angular.forEach(a(b),function(a){i.push(h(a,g(c,d,e,f)))}),function(){angular.forEach(i,function(a){a()})}},r=function(a,b,c,d){q(a,b,c,d,!0)},s=function(a,b){var c=angular.remove(k[a],function(a){return angular.equals(a.callback,b)});return c.length>0},t=function(a){angular.forEach(k,function(b){angular.remove(b,function(b){return angular.equals(j(a),j(b.ref))})})},u=function(b){angular.forEach(a(b),function(a,b){k[b].length=0})};return{logListeners:n,trigger:o,on:q,once:r,off:s,destroy:t,reject:p,clear:u}}return a.$clotho.$pubsub?a.$clotho.$pubsub:a.$clotho.$pubsub=e()}]),angular.module("clotho.core").service("Communicator",["ClothoAuth","Socket","ClothoREST","Debug",function(a,b,c,d){function e(a){return a.length<h}var f=new d("Communicator","#bbbb55"),g=(angular.fromJson,angular.toJson),h=16348,i=function(a){return e(a)?1===b.state()?!0:!0:!1},j=function(a,d){if(d===!0)return c.send(a);var e=angular.isObject(a)?g(a):a;return i(e)?b.send(e):(f.warn("Message must be sent over REST",a),c.send(a))},k=function(a,b,c,d,e){var f={channel:a,data:b,options:c},g=j(f,e);return g&&angular.isFunction(d)&&d(g,f),g};return{send:j,emit:k}}]),angular.module("clotho.core").service("ClothoREST",["$http","ClothoAuth","Debug",function(a,b,c){var d="",e=(new c("ClothoREST","#bbbb55"),function(){return{method:"GET",url:d,headers:{}}}),f=function(b){a(e(b))};return{send:f}}]),angular.module("clotho.core").service("Socket",["$window","$q","$log","PubSub","ClientAPI","Debug",function(a,b,c,d,e,f){function g(){function b(a){return{"class":"error",from:"client",text:a}}function c(a){return a.length<16348}function g(a){return 1!==j.readyState?(l.log("(not ready) queueing request: ",a),void k.push(a)):(a=angular.isObject(a)?JSON.stringify(a):a,c(a)?(l.log("sending data: ",angular.isObject(a)?a:JSON.parse(a)),j.send(a),!0):(l.warn("Message did not pass validation!"),e.say(b("Message could not be sent to server")),!1))}function h(){l.group("Sending Socket Queue"),angular.forEach(k,function(a){g(a)}),l.groupEnd(),k=[]}function i(){var c=window.location.pathname,d=c.substring(0,c.lastIndexOf("/"));/\.html/.test(d)&&(d=d.substring(0,d.lastIndexOf("/")));var f="https:"==window.location.protocol?"wss:":"ws:";j=a.$clotho.socket=new WebSocket(f+"//"+window.location.host+d+"/websocket"),j.onopen=function(){l.log("opened, sending queued items..."),h()},j.onerror=function(a){l.error("socket error",a)},j.onclose=function(a){l.error("socket closed",a),e.say(b("Socket Connection Closed (Please Reload)"+(a.reason?" - "+a.reason:"")))}}var j,k=[],l=new f("Socket","#5555bb");return a.$clotho.socket?j=a.$clotho.socket:i(),j.onmessage=function(a){a=JSON.parse(a.data),l.log("received",a);var b=a.channel,c=a.requestId,f=angular.isUndefined(a.data),g=a.data;if(angular.isFunction(e[b]))e[b](g);else{var h=f?"reject":"trigger";c?d[h](b+":"+c,g):d[h](b,g)}},{state:function(){return j.readyState},send:g}}return a.$clotho.$socket?a.$clotho.$socket:a.$clotho.$socket=g()}]),angular.module("clotho.core").service("ClothoCommandHistory",["PubSub","$filter",function(a,b){function c(a){return a=a||g,b("filter")(f,function(b){return b.timestamp>a})}function d(a){a=a||g,f.unread=c(a).length}function e(a){a=angular.extend({timestamp:Date.now()},a),f.unshift(a),d()}var f=[],g=Date.now();return f.unread=0,e({text:"Welcome to Clotho!",from:"server","class":"success",timestamp:Date.now()}),{entries:f,addMessage:e,getLastView:function(){return g},setLastView:function(a){g=a||Date.now(),d(g)},toggleTerminal:function(){return a.trigger("toggleTerminalActive")}}}]);