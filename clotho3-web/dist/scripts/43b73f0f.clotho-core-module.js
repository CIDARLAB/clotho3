var $clotho=window.$clotho=window.$clotho||{};angular.module("clotho.core",["clotho.angularAdditions"]),angular.module("clotho.angularAdditions",["ngSanitize","ngRoute"]).config(function(){var a={};a.isEmpty=function(a){return angular.isUndefined(a)||""===a||null===a||a!==a},a.isScope=function(a){return a&&a.$evalAsync&&a.$watch},angular.extend(angular,a)}).run(["$rootScope",function(a){a.$safeApply=function(){var a,b,c=!1;if(1==arguments.length){var d=arguments[0];"function"==typeof d?b=d:a=d}else a=arguments[0],b=arguments[1],3==arguments.length&&(c=!!arguments[2]);a=a||this,b=b||function(){},c||!a.$$phase?a.$apply?a.$apply(b):a.apply(b):b()}}]),angular.module("clotho.core").service("Clotho",["Socket","Collector","PubSub","$window","$q","$rootScope","$location","$timeout",function(a,b,c,d,e,f,g){function h(){var d={};d.send=function(b){a.send(angular.toJson(b))},d.pack=function(a,b,c,d){return{channel:a,data:b,requestId:c,options:d}},d.emit=function(a,b,c,e){d.send(d.pack(a,b,c,e))},d.api={},d.searchbar={},d.api.emit=function(a,b,c){d.emit(a,b,c)},d.searchbar.emit=function(a,b,c){d.emit(a,b,c)},d.emitSubCallback=function(a,b,g,h){var i=e.defer(),j=Date.now().toString();return angular.isFunction(g)||(g=angular.noop()),c.once(a+":"+j,function(a){f.$safeApply(i.resolve(a)),g(a)},"$clotho"),d.emit(a,b,j,h),i.promise},d.emitSubOnce=function(a,b,c){return d.emitSubCallback(a,b,angular.noop,c)};var h=function(a,b){var c={username:a,password:b};return d.emitSubOnce("login",c)},i=function(a,b,c){return c="undefined"!=typeof c?!!c:!1,c?k(a,b):j(a,b)},j=function(a,c){var f=b.retrieveModel(a);if(f){var g=e.defer();return g.resolve(f),g.promise}var h=function(c){b.storeModel(a,c)};return d.emitSubCallback("get",a,h,c)},k=function(a){var c=b.retrieveModel(a);return c?c:void 0},l=function(a){if(angular.isEmpty(a))return!1;for(;a.$$v;)a=a.$$v;var c=function(){b.storeModel(a.id,a)};return d.emitSubCallback("set",a,c)},m=function(a,b,d){d="undefined"!=typeof d?d:null,c.on("update:"+a,function(a){f.$safeApply(b(a))},d)},n=function(a,b,d,e){e="undefined"!=typeof e?e:null,c.on("update:"+a,function(a){f.$safeApply(b[d]=a)},e)},o=function(a,b,d){d="undefined"!=typeof d?d:null,c.on(a,function(a){f.$safeApply(b(a))},d)},p=function(a,b){c.trigger(a,b)},q=function(a){c.destroy(a)},r=function(a,b){d.api.emit(a,b||{})},s=function(a,b){d.api.emit("broadcast",d.pack(a,b))},t=function(b,c){return a.on(b,c)},u=function(b,c){return a.once(b,c)},v=function(b){a.off(b)},w=function(a,c){var e=function(a){angular.forEach(a,function(a){b.storeModel(a.id,a)})};return d.emitSubCallback("query",a,e,c)},x=function(a){return d.emitSubOnce("create",a)},y=function(a){var c=function(){b.removeModel(a)};return d.emitSubCallback("destroy",a,c)},z=function(a){g.path("/editor/"+a)},A=function(a,b){var c={uuid:a,timestamp:b};return d.emitSubOnce("revert",c)},B=function(a){return d.emitSubOnce("validate",a)},C=function(a,b){var c={uuid:a,args:b};d.api.emit("show_old",c)},D=function(a){d.api.emit("show",a)},E=function(){console.log("need to set up share")},F=0,G=function(a){F++;var b=F,c=e.defer(),d=$($('<div clotho-widget clotho-widget-uuid="'+b+'" clotho-widget-name="'+a.moduleName+'"></div>').append("<div ng-view></div>")).appendTo($clotho.appWidgets),g=a.moduleUrl?a.moduleUrl+"?_="+Date.now():"";return $script(g,function(){angular.bootstrap(d,[a.moduleName]),c.resolve([b,"[clotho-widget-uuid="+b+"]"]),f.$safeApply()}),c.promise},H=function(a){d.api.emit("log",a)},I=function(a,b){var c={userID:b||"",msg:a,timestamp:Date.now()};d.api.emit("say",c)},J=function(a){d.api.emit("notify",a)},K=function(a,b){var c={userID:b,msg:a};d.api.emit("alert",c)},L=function(a){var b={query:a};return d.emitSubOnce("autocomplete",b)},M=function(a){var g=e.defer();if(b.hasItem("detail_"+a))g.resolve(b.retrieveModel("detail_"+a));else{var h={uuid:a};d.searchbar.emit("autocompleteDetail",h),c.once("update:detail_"+a,function(a){f.$safeApply(g.resolve(a))},"$clotho")}return g.promise},N=function(a){return d.emitSubOnce("submit",a)},O=function(a,b){var c={id:a,args:b};return d.emitSubOnce("run",c)},P=function(a){return d.emitSubOnce("recent",a)},Q=function(a,b,c){return O("gradeQuiz",[a,b,c])};return{login:h,get:i,set:l,query:w,create:x,edit:z,validate:B,revert:A,destroy:y,show:D,show_old:C,say:I,log:H,alert:K,run:O,recent:P,notify:J,gradeQuiz:Q,bootstrap:G,watch:m,watch2:n,listen:o,silence:q,trigger:p,emit:r,broadcast:s,on:t,once:u,off:v,share:E,submit:N,autocomplete:L,autocompleteDetail:M}}return d.$clotho.api?d.$clotho.api:d.$clotho.api=h()}]),angular.module("clotho.core").service("ClientAPI",["PubSub","Collector","$q","$templateCache","$http","$rootScope","$location","$compile",function(a,b,c,d,e,f,g){var h=function(a){var c=a,d=c.id||c.uuid||!1;b.storeModel(d,c)},i=function(a){g.path("/editor/"+a)},j=function(a){g.path(a)},k=function(){},l=function(b){a.trigger(b.channel,b.data)},m=function(a,b){b.model,b.template},n=function(a){console.log(a);var b=a.template,c=a.controller||"",g=a.args||{},h=a.dependencies||[],i=a.styles||{},j=a.target&&$($clotho.appRoot).has(a.target)?a.target:$($clotho.appRoot).find("[ng-view]");f.$safeApply(e.get(b,{cache:d}).success(function(a){Application.mixin([h,c],$(a).appendTo(j),g).then(function(a){a.css(i)})}).error(function(){console.log("error getting template")}))},o=function(){},p=function(a){console.log(a)},q=function(b){b.timestamp=b.timestamp?b.timestamp:Date.now(),b.from=b.from?b.from:"server",a.trigger("activityLog",b)},r=function(b){a.trigger("serverAlert",{}),window.alert(b)},s=function(){},t=function(b,c){a.trigger("revisions:"+b,c)},u=function(a){g.path("/trails/"+a)},v=function(c){console.log("Hit autocompletedetail"),console.log(c);var d=c.command_object.function_id;b.storeModel("detail_"+d,c),a.trigger("autocompleteDetail_"+d,c)};return{collect:h,edit:i,changeUrl:j,notify:k,broadcast:l,log:p,say:q,alert:r,display:n,display_simple:n,display_old:m,hide:o,help:s,revisions:t,startTrail:u,autocompleteDetail:v}}]),angular.module("clotho.core").service("Collector",["$window","$document","PubSub",function(a,b,c){function d(){function b(a,b){c.trigger("update",a),c.trigger("update:"+a,angular.copy(b))}function d(){var c=a.localStorage,d=JSON,e="clotho_",f=function(){try{return"localStorage"in a&&null!==a.localStorage}catch(b){return!1}},g=function(){return c.clear(),this},h=function(a,b){var f=c.getItem(e+a);return"undefined"==typeof f||f===!1?"undefined"!=typeof b?b:null:d.parse(f)},i=function(a){var b=c.getItem(e+a);return null!=b&&"undefined"!=typeof b},j=function(a){return c.removeItem(e+a),this},k=function(a,b){return b||0===b||""===b?(c.setItem(e+a,d.stringify(b)),this):!1},l=function(c){c||(c=a.event);var d=c.key.replace(e,"")||"",f=h(d);console.log("handle_storage_event for "+d),b(d,f)};return a.addEventListener?a.addEventListener("storage",l,!1):a.attachEvent("onstorage",l),{getPrefix:function(){return e},isSupported:f,clear:g,getItem:h,hasItem:i,removeItem:j,setItem:k}}var e=d(),f={},g=function(a,b){f[a]=b,e.setItem(a,b)},h=function(a,c,d){d||!angular.equals(f[a],c)?(g(a,c),b(a,c)):console.log("COLLECTOR	"+a+"model is same as collector")},i=function(a){return angular.copy(j(a))},j=function(a){return"undefined"==typeof a?f:f[a]&&"undefined"!=typeof f[a]?f[a]:(f[a]=e.getItem(a))?f[a]:!1},k=function(a){return f[a]?(f[a]=null,e.removeItem(a),!0):!1},l=function(){e.clear(),f={},c.trigger("collector_reset",null)};return{collector:f,hasItem:e.hasItem,silentAddModel:g,storeModel:h,retrieveModel:i,retrieveRef:j,removeModel:k,clearStorage:l}}return a.$clotho.$collector?a.$clotho.$collector:a.$clotho.$collector=d()}]),angular.module("clotho.core").service("PubSub",function(){function a(){var a={},b={},c=/\s+/,d=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},e=function(b,c,e,f){a[b]||(a[b]=[]),a[b].push([c,f]);var g=[b,c];return e&&"undefined"!=typeof e&&(angular.isScope(e)?(e.$on("$destroy",function(){l(e.$id)}),d(e.$id,g)):d(e,g)),g},f=function(b){var c=b[0];a[c]&&angular.forEach(a[c],function(d,e){d[0]==b[1]&&a[c].splice(e,1)})},g=function(){console.log(a)},h=function(b,d){var e=b.split(c);angular.forEach(e,function(b){a[b]&&angular.forEach(a[b],function(c,e){c[0](d),c[1]&&a[b].splice(e,1)})})},i=function(a,b,d,f){if(d=d||null,f=f||!1,c.test(a)){var g=[],h=a.split(c);return angular.forEach(h,function(a){var c=e(a,b,d,f);g.push(c)}),g}return e(a,b,d,f)},j=function(a,b,c){i(a,b,c,!0)},k=function(a){angular.isArray(a[0])?angular.forEach(a,function(a){f(a)}):f(a)},l=function(a){var c=b[a];angular.forEach(c,function(a){f(a)}),b[a]=[]},m=function(d){"all"==d&&(a={},b={});var e=d.split(c);angular.forEach(e,function(b){a[b]=[]})};return{logListeners:g,trigger:h,on:i,once:j,off:k,destroy:l,clear:m}}return window.$clotho.$pubsub?window.$clotho.$pubsub:window.$clotho.$pubsub=a()}),angular.module("clotho.core").service("Socket",["$window","$q","PubSub","ClientAPI",function(a,b,c,d){function e(){var b,e,f=[];return b=a.$clotho.socket?a.$clotho.socket:a.$clotho.socket=new WebSocket("wss://"+window.location.host+window.location.pathname+"websocket"),1==b.readyState?(console.log("socket already present, sending items in socket Queue"),e=!0,angular.forEach(f,function(a,c){b.send(a),f.splice(c,1)})):b.onopen=function(){console.log("socket opened, sending queued items"),e=!0,angular.forEach(f,function(a,c){b.send(a),f.splice(c,1)})},b.onopen=function(){console.log("socket opened, sending queued items"),e=!0,angular.forEach(f,function(a){b.send(a)})},b.onerror=function(){e=!1,console.log("socket error")},b.onclose=function(){d.say({"class":"error",text:"Socket Connection Closed",from:"client"})},b.onmessage=function(a){a=JSON.parse(a.data),console.log("SOCKET	received",a);var b=a.channel,e=a.requestId,f=a.data;"function"==typeof d[b]?d[b](f):c.trigger(b+":"+e,f)},{emit:function(a,c,d){console.log("SOCKET	data emitted on channel: "+a);var e={channel:a,data:c};b.send(e),"function"==typeof d&&d(e)},send:function(a){return e?(console.log("SOCKET	sending data: "+a),b.send(a),void 0):(console.log("socket not ready, queueing request"),f.push(a),void 0)}}}return a.$clotho.$socket?a.$clotho.$socket:a.$clotho.$socket=e()}]);