var $clotho=window.$clotho=window.$clotho||{};angular.module("clotho.core",["clotho.angularAdditions"]),angular.module("clotho.angularAdditions",[]).config(function(){var a={};a.isEmpty=function(a){return angular.isDefined(_)&&_.isEmpty(a)||angular.isUndefined(a)||""===a||null===a||a!==a},a.isScope=function(a){return a&&a.$evalAsync&&a.$watch},a.once=function(a){var b,c;if(!angular.isFunction(a))throw new TypeError;return function(){return b?c:(b=!0,c=a.apply(this,arguments),a=null,c)}},angular.extend(angular,a)}).run(["$rootScope",function(a){a.$safeApply=function(){var a,b,c=!1;if(1==arguments.length){var d=arguments[0];"function"==typeof d?b=d:a=d}else a=arguments[0],b=arguments[1],3==arguments.length&&(c=!!arguments[2]);a=a||this,b=b||function(){},c||!a.$$phase?a.$apply?a.$apply(b):a.apply(b):b()}}]),angular.module("clotho.core").config(["$provide",function(a){a.decorator("$log",["$delegate",function(a){return a.table=function(){var b=[].slice.call(arguments);window.console&&window.console.table?console.table(b[0],b[1]):a.log(null,b)},a}])}]).factory("Debug",["$log",function(a){function b(a){return c===!0?!1:d.indexOf(a)<0}var c=!1,d=[],e={};return function(c,d){c=angular.isString(c)?c:"ANONYMOUS",d=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(d)?d:"#"+Math.floor(16777215*Math.random()).toString(16),e[c]=[];var f={};return angular.forEach(["log","warn","error","debug","info","table"],function(g){f[g]=function(){var f=new Date,h=f.getHours()+":"+f.getMinutes()+":"+f.getSeconds()+"."+f.getMilliseconds();e[c].push({message:arguments,date:h}),b(c)&&a[g].apply(null,["%c"+h+" - "+c+"	","color: "+d+";"].concat(Array.prototype.slice.call(arguments,0)))}}),f}}]),angular.module("clotho.core").service("Clotho",["Socket","Collector","PubSub","$window","$q","$rootScope","$location","$timeout",function(a,b,c,d,e,f,g,h){function i(){var d={};d.send=function(b){a.send(angular.toJson(b))},d.pack=function(a,b,c,d){return{channel:a,data:b,requestId:c,options:d}},d.emit=function(a,b,c,e){d.send(d.pack(a,b,c,e))};var f=new function(){var a=0;this.next=function(){return a+=1,a.toString()}};d.emitSubCallback=function(a,b,g,i){var j=e.defer(),k=Date.now().toString()+f.next();angular.isFunction(g)||(g=angular.noop());var l=h(function(){j.reject(null)},5e3);return c.once(a+":"+k,function(a){h.cancel(l),j.resolve(a),g(a)},"$clotho"),d.emit(a,b,k,i),j.promise},d.emitSubOnce=function(a,b,c){return d.emitSubCallback(a,b,angular.noop,c)};var i=function(a,b){var c={username:a,password:b};return d.emitSubOnce("login",c)},j=function(){return d.emitSubOnce("logout","")},k=function(a,b,c){return c="undefined"!=typeof c?!!c:!1,c?m(a,b):l(a,b)},l=function(a,c){if(angular.isUndefined(a))return e.when();var f=b.retrieveModel(a);if(f){var g=e.defer();return g.resolve(f),g.promise}var h=function(c){b.storeModel(a,c)};return d.emitSubCallback("get",a,h,c)},m=function(a){if(!angular.isUndefined(a)){var c=b.retrieveModel(a);return c?c:void 0}},n=function(a){if(angular.isEmpty(a))return!1;for(;a.$$v;)a=a.$$v;var c=function(){b.storeModel(a.id,a)};return d.emitSubCallback("set",a,c)},o=function(a,b,d,e){d="undefined"!=typeof d?d:null,c.on("update:"+a,function(a){angular.isFunction(b)?b.apply(d,a):e?angular.extend({},a):angular.extend(b,a)},d)},p=function(a,b,d){d="undefined"!=typeof d?d:null,c.on(a,function(a){b(a)},d)},q=function(a,b){c.trigger(a,[b])},r=function(a){c.destroy(a)},s=function(a,b){d.emit(a,b||{})},t=function(a,b){d.emit("broadcast",d.pack(a,b))},u=function(b,c){return a.on(b,c)},v=function(b,c){return a.once(b,c)},w=function(b){a.off(b)},x=function(a,c){var e=function(a){angular.forEach(a,function(a){b.storeModel(a.id,a)})};return d.emitSubCallback("query",a,e,c)},y=function(a){return d.emitSubOnce("create",a)},z=function(a){var c=function(){b.removeModel(a)};return d.emitSubCallback("destroy",a,c)},A=function(a){g.path("/editor/"+a)},B=function(a,b){var c={uuid:a,timestamp:b};return d.emitSubOnce("revert",c)},C=function(a){return d.emitSubOnce("validate",a)},D=function(a,b){var c={uuid:a,args:b};d.api.emit("show_old",c)},E=function(a,b){var c={viewId:a,options:b};d.emit("show",c)},F=function(){console.log("need to set up share")},G=function(a){d.emit("log",a)},H=function(a,b){var c={userID:b||"",msg:a,timestamp:Date.now()};d.emit("say",c)},I=function(a){d.emit("notify",a)},J=function(a,b){var c={userID:b,msg:a};d.emit("alert",c)},K=function(a){var b={query:a};return d.emitSubOnce("autocomplete",b)},L=function(a){var f=e.defer();if(b.hasItem("detail_"+a))f.resolve(b.retrieveModel("detail_"+a));else{var g={uuid:a};d.emit("autocompleteDetail",g),c.once("update:detail_"+a,function(a){f.resolve(a)},"$clotho")}return f.promise},M=function(a){return d.emitSubOnce("submit",a)},N=function(a,b){var c={id:a,args:b};return d.emitSubOnce("run",c)},O=function(a){return d.emitSubOnce("recent",a)},P=function(a,b,c){return N("gradeQuiz",[a,b,c])};return{login:i,logout:j,get:k,set:n,query:x,create:y,edit:A,validate:C,revert:B,destroy:z,show:E,show_old:D,say:H,log:G,alert:J,run:N,recent:O,notify:I,gradeQuiz:P,submit:M,autocomplete:K,autocompleteDetail:L,watch:o,listen:p,silence:r,trigger:q,emit:s,broadcast:t,on:u,once:v,off:w,share:F}}return d.$clotho.api?d.$clotho.api:d.$clotho.api=i()}]),angular.module("clotho.core").service("ClientAPI",["PubSub","Collector","$q","$templateCache","$http","$rootScope","$location","$compile",function(a,b,c,d,e,f,g,h){var i,j=!1;try{angular.module("clotho.interface"),j=!0,i=angular.injector("clotho.interface").get("$modal")}catch(k){}var l=function(a){var c=a,d=c.id||c.uuid||!1;b.storeModel(d,c)},m=function(a){if(j){var b={backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:'<form sharable-editor ng-model="'+a+'" class="col-sm-6 form-horizontal well"></form>'};i.open(b)}else g.path("/editor/"+a)},n=function(a){g.path(a)},o=function(b){a.trigger(b.channel,[b.data])},p=function(a,b){b.model,b.template},q=function(a,b){var c=angular.element('<div clotho-show="'+a+'"></div>'),d=document.querySelector(b);d||(d=document.getElementById("clothoAppWidgets")),d=angular.element(d),d.append(h(c)(f))},r=function(a,b){var c=angular.element(document.querySelector('[clotho-show="'+a+'"]'));b.apply(null,c.remove())},s=function(a){console.log(a)},t=function(b){var c={"class":"muted",from:"server",timestamp:Date.now().valueOf()},d={success:"success",warning:"warning",failure:"danger",normal:"success",muted:"muted",info:"info"};angular.extend(c,b),c.class=d[angular.lowercase(c.class)],a.trigger("activityLog",[c])},u=function(b){a.trigger("serverAlert"),j?f.$safeApply(i.serverAlert(b).result.then(function(a){console.log("dialog closed with result: "+a)})):window.alert(b)},v=function(){},w=function(b,c){a.trigger("revisions:"+b,[c])},x=function(a){g.path("/trails/"+a)},y=function(c){console.log("Hit autocompletedetail"),console.log(c);var d=c.command_object.function_id;b.storeModel("detail_"+d,c),a.trigger("autocompleteDetail_"+d,[c])};return{collect:l,edit:m,changeUrl:n,broadcast:o,log:s,say:t,alert:u,display:q,display_simple:q,display_old:p,hide:r,help:v,revisions:w,startTrail:x,autocompleteDetail:y}}]),angular.module("clotho.core").service("Collector",["$window","$document","PubSub","Debug",function(a,b,c,d){function e(){function b(a,b){c.trigger("update",[a]),c.trigger("update:"+a,[angular.copy(b)])}function e(){var c=a.localStorage,d=JSON,e="clotho_",g=function(){try{return"localStorage"in a&&null!==a.localStorage}catch(b){return!1}},h=function(){return c.clear(),this},i=function(a,b){var f=c.getItem(e+a);return"undefined"==typeof f||f===!1?angular.isDefined(b)?b:null:angular.isObject(f)?f:d.parse(f)},j=function(a){var b=c.getItem(e+a);return null!=b&&"undefined"!=typeof b},k=function(a){return c.removeItem(e+a),this},l=function(a,b){return b||0===b||""===b?(c.setItem(e+a,d.stringify(b)),this):!1},m=function(c){c||(c=a.event);var d=c.key.replace(e,"")||"",g=i(d);f.log("handle_storage_event for "+d),b(d,g)};return a.addEventListener?a.addEventListener("storage",m,!1):a.attachEvent("onstorage",m),{getPrefix:function(){return e},isSupported:g,clear:h,getItem:i,hasItem:j,removeItem:k,setItem:l}}var f=new d("Collector","#55bb55"),g=e(),h={},i=function(a,b){h[a]=b,g.setItem(a,b)},j=function(a,c,d){d||!angular.equals(l(a),c)?(f.log(a+" (saving)",h[a],c),i(a,c),b(a,c)):f.log(a+" (model unchanged)")},k=function(a){return angular.copy(l(a))},l=function(a){return"undefined"==typeof a?h:h[a]&&"undefined"!=typeof h[a]?h[a]:(h[a]=g.getItem(a))?h[a]:!1},m=function(a){return h[a]?(h[a]=null,g.removeItem(a),!0):!1},n=function(){g.clear(),h={},c.trigger("collector_reset")};return{collector:h,hasItem:g.hasItem,silentAddModel:i,storeModel:j,retrieveModel:k,retrieveRef:l,removeModel:m,clearStorage:n}}return a.$clotho.$collector?a.$clotho.$collector:a.$clotho.$collector=e()}]),angular.module("clotho.core").service("PubSub",["$rootScope","Debug",function(a,b){function c(){function c(a){return a?"all"==a?Object.keys(j):a.split(k):[]}function d(a){return j.hasOwnProperty(a)}function e(a){return d(a)&&j[a].length>0}function f(a,b,c,d){return angular.isFunction(a)?{callback:a,ref:b||null,priority:parseInt(c)||100,once:1==d}:null}function g(a,b){if(b&&!_.isEmpty(b)){j[a]||(j[a]=[]);var c=b.ref;return angular.isScope(c)&&c.$on("$destroy",function(){r(i(c))}),j[a].push(b),_.once(function(){h(a,b)})}return _.noop}function h(a,b){var c=_.remove(j[a],function(a){return _.isEqual(a,b)});return c.length>0}function i(a){return angular.isScope(a)?a.$id:a}var j={},k=/\s+/,l=new b("PubSub","#cc5555"),m=function(){l.log("LISTENERS:"),_.forEach(j,function(a,b){l.log(b),l.table(j[b])})},n=function(b,d){_.isUndefined(d)||_.isEmpty(d)?d=null:_.isArray(d)||(d=[d]),_.forEach(c(b),function(b){l.log("Publish on "+b,d),e(b)&&_.map(_.sortBy(j[b],"priority"),function(c,e){a.$safeApply(function(){c.callback.apply(c.ref,d)}),1==c.once&&j[b].splice(e,1)})})},o=function(a,b,d,e,h){d=d||null,h=1==h,h&&(b=_.once(b));var i=[];return _.forEach(c(a),function(a){i.push(g(a,f(b,d,e,h)))}),function(){_.forEach(i,function(a){a()})}},p=function(a,b,c,d){o(a,b,c,d,!0)},q=function(a,b){var c=_.remove(j[a],function(){return _.isEqual(subscriber.callback,b)});return c.length>0},r=function(a){_.forEach(j,function(b){_.remove(b,function(b){return _.isEqual(i(a),i(b.ref))})})},s=function(a){_.forEach(c(a),function(a,b){j[b].length=0})};return{logListeners:m,trigger:n,on:o,once:p,off:q,destroy:r,clear:s}}return window.$clotho.$pubsub?window.$clotho.$pubsub:window.$clotho.$pubsub=c()}]),angular.module("clotho.core").service("Socket",["$window","$q","PubSub","ClientAPI","Debug",function(a,b,c,d,e){function f(){function b(a){return h?(a=angular.isObject(a)?JSON.stringify(a):a,j.log("sending data: "+a),void g.send(a)):(j.log("(not ready) queueing request: ",a),void i.push(a))}function f(){angular.forEach(i,function(a){b(a)}),i=[]}var g,h,i=[],j=new e("Socket","#5555bb");return g=a.$clotho.socket?a.$clotho.socket:a.$clotho.socket=new WebSocket("wss://"+window.location.host+window.location.pathname+"websocket"),1==g.readyState?(j.log("already exists, sending items in socket Queue..."),h=!0,f()):g.onopen=function(){j.log("opened, sending queued items..."),h=!0,f()},g.onerror=function(a){j.error(a)},g.onclose=function(){h=!1,d.say({"class":"error",text:"Socket Connection Closed",from:"client"})},g.onmessage=function(a){a=JSON.parse(a.data),j.log("received",a);var b=a.channel,e=a.requestId,f=a.data;"function"==typeof d[b]?d[b](f):c.trigger(b+":"+e,[f])},{state:function(){return g.readyState},emit:function(a,c,d){var e={channel:a,data:c};b(e),"function"==typeof d&&d(e)},send:b}}return a.$clotho.$socket?a.$clotho.$socket:a.$clotho.$socket=f()}]);