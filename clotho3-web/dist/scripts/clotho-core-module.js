var $clotho=window.$clotho=window.$clotho||{};angular.module("clotho.core",["clotho.angularAdditions"]),angular.module("clotho.angularAdditions",[]).config(function(){var a={};a.isEmpty=function(a){try{return _.isEmpty(a)}catch(b){if(angular.isNumber(a))return a===a;if(angular.isObject(a)){if(0===a.length)return!0;for(var c in a)if(a.hasOwnProperty(c))return!1;return!0}return angular.isUndefined(a)||null===a||0==a.length?!0:!1}},a.isScope=function(a){return!!a&&angular.isFunction(a.$evalAsync)&&angular.isFunction(a.$watch)},a.once=function(a){var b,c;if(!angular.isFunction(a))throw new TypeError;return function(){return b?c:(b=!0,c=a.apply(this,arguments),a=null,c)}},a.remove=function(a,b,c){var d=-1,e=a?a.length:0,f=[];for(c=c||null;++d<e;){var g=a[d];(angular.isUndefined(g)||b.call(c,g,d,a))&&(angular.isDefined(g)&&f.push(g),a.splice(d--,1),e--)}return f},a.map=function(a,b,c){var d=[];return angular.forEach(a,function(a,e,f){angular.isFunction(b)&&d.push(b.call(c,a,e,f))}),d},angular.extend(angular,a)}).run(["$rootScope",function(a){a.$safeApply=function(){var a,b,c=!1;if(1==arguments.length){var d=arguments[0];"function"==typeof d?b=d:a=d}else a=arguments[0],b=arguments[1],3==arguments.length&&(c=!!arguments[2]);a=a||this,b=b||function(){},c||!a.$$phase?a.$apply?a.$apply(b):a.apply(b):b()}}]),angular.module("clotho.core").config(["$provide",function(a){a.decorator("$log",["$delegate",function(a){return a.table=function(){var b=[].slice.call(arguments);window.console&&window.console.table?console.table(b[0],b[1]):a.log(null,b)},a}])}]).factory("Debug",["$log","$window",function(a,b){function c(a){return d===!0?!1:e.indexOf(a)<0}var d=!1,e=[],f={};return function(d,e){d=angular.isString(d)?d:"ANONYMOUS",e=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e)?e:"#"+Math.floor(16777215*Math.random()).toString(16),f[d]=[];var g={};return angular.forEach(["log","warn","error","debug","info"],function(b){g[b]=function(){var g=new Date,h=g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()+"."+g.getMilliseconds();f[d].push({message:arguments,time:g.valueOf()}),c(d)&&a[b].apply(null,["%c"+h+" - "+d+"	","color: "+e+";"].concat(Array.prototype.slice.call(arguments,0)))}}),angular.forEach(["table"],function(a){g[a]=b.console[a]}),g.object=function(b){f[d].push({message:b,time:Date.now().valueOf()}),angular.isObject(b)?a.log("%c"+JSON.stringify(b,null,2),"color: "+e+";"):a.log("%c"+b,"color: "+e+";")},g.$log=a,g.console=b.console||{},g}}]),angular.module("clotho.core").service("Clotho",["Socket","Collector","PubSub","Debug","$window","$q","$rootScope","$location","$timeout",function(a,b,c,d,e,f,g,h,i){function j(){var e=(new d("ClothoAPI","#cc5555"),{});e.send=function(b){a.send(angular.toJson(b))},e.pack=function(a,b,c,d){return{channel:a,data:b,requestId:c,options:d}},e.emit=function(a,b,c,d){e.send(e.pack(a,b,c,d))};var g=new function(){var a=0;this.next=function(){return a+=1,a.toString()}};e.emitSubCallback=function(a,b,d,h){var j=f.defer(),k=Date.now().toString()+g.next();angular.isFunction(d)||(d=angular.noop);var l=i(function(){j.reject(null)},5e3);return c.once(a+":"+k,function(a){i.cancel(l),angular.isEmpty(a)&&(a=null),j.resolve(a),d(a)},"$clotho"),e.emit(a,b,k,h),j.promise},e.emitSubOnce=function(a,b,c){return e.emitSubCallback(a,b,angular.noop,c)};var j=function(a,b){var c={username:a,password:b};return e.emitSubOnce("login",c)},k=function(){return e.emitSubOnce("logout","")},l=function(a,b,c){return c="undefined"!=typeof c?!!c:!1,c?n(a,b):m(a,b)},m=function(a,c){if(angular.isUndefined(a))return f.when();var d=b.retrieveModel(a);if(d){var g=f.defer();return g.resolve(d),g.promise}var h=function(c){b.storeModel(a,c)};return e.emitSubCallback("get",a,h,c)},n=function(a){if(!angular.isUndefined(a)){var c=b.retrieveModel(a);return c?c:void 0}},o=function(a){if(angular.isEmpty(a))return!1;for(;a.$$v;)a=a.$$v;var c=function(){b.storeModel(a.id,a)};return e.emitSubCallback("set",a,c)},p=function(a,b,d,e){d="undefined"!=typeof d?d:null,c.on("update:"+a,function(a){angular.isFunction(b)?b.apply(d,a):e?angular.extend({},a):angular.extend(b,a)},d)},q=function(a,b,d){d="undefined"!=typeof d?d:null,c.on(a,function(a){b(a)},d)},r=function(a,b){c.trigger(a,b)},s=function(a){c.destroy(a)},t=function(a,b){e.emit(a,b||{})},u=function(a,b){e.emit("broadcast",e.pack(a,b))},v=function(b,c){return a.on(b,c)},w=function(b,c){return a.once(b,c)},x=function(b){a.off(b)},y=function(a,c){var d=function(c){console.groupCollapsed("Query Results for: "+JSON.stringify(a)),angular.forEach(c,function(a){b.storeModel(a.id,a)}),console.groupEnd()};return e.emitSubCallback("query",a,d,c)},z=function(a){return e.emitSubOnce("create",a)},A=function(a){var c=function(){b.removeModel(a)};return e.emitSubCallback("destroy",a,c)},B=function(a){h.path("/editor/"+a)},C=function(a,b){var c={uuid:a,timestamp:b};return e.emitSubOnce("revert",c)},D=function(a){return e.emitSubOnce("validate",a)},E=function(a,b){var c={viewId:a,options:b};e.emit("show",c)},F=function(){console.log("need to set up share")},G=function(a){e.emit("log",a)},H=function(a,b){var c={userID:b||"",msg:a,timestamp:Date.now()};e.emit("say",c)},I=function(a){e.emit("notify",a)},J=function(a,b){var c={userID:b,msg:a};e.emit("alert",c)},K=function(a,b){var d=function(a){c.trigger("autocomplete",a)},f={query:a};return e.emitSubCallback("autocomplete",f,d,b)},L=function(a){var d=f.defer();if(b.hasItem("detail_"+a))d.resolve(b.retrieveModel("detail_"+a));else{var g={uuid:a};e.emit("autocompleteDetail",g),c.once("update:detail_"+a,function(a){d.resolve(a)},"$clotho")}return d.promise},M=function(a){return e.emitSubOnce("submit",a)},N=function(a,b){var c={id:a,args:b};return e.emitSubOnce("run",c)},O=function(a){return e.emitSubOnce("recent",a)},P=function(a,b,c){return N("gradeQuiz",[a,b,c])};return{login:j,logout:k,get:l,set:o,query:y,create:z,edit:B,validate:D,revert:C,destroy:A,show:E,say:H,log:G,alert:J,run:N,recent:O,notify:I,gradeQuiz:P,submit:M,autocomplete:K,autocompleteDetail:L,watch:p,listen:q,silence:s,trigger:r,emit:t,broadcast:u,on:v,once:w,off:x,share:F}}return e.$clotho.api?e.$clotho.api:e.$clotho.api=j()}]),angular.module("clotho.core").service("ClientAPI",["PubSub","Collector","Debug","$q","$injector","$window","$templateCache","$http","$rootScope","$location","$compile",function(a,b,c,d,e,f,g,h,i,j,k){var l,m=new c("ClientAPI","#dd99dd");e.has("$modal")&&(l=e.get("$modal"));var n=function(a){var c=a,d=c.id||c.uuid||!1;b.storeModel(d,c)},o=function(a){if(angular.isDefined(l)){var b={backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:'<form sharable-editor ng-model="'+a+'" class="col-sm-6 form-horizontal well"></form>'};l.open(b)}else j.path("/editor/"+a)},p=function(a){j.path(a)},q=function(b){a.trigger(b.channel,b.data)},r=function(a,b){var c=angular.element('<div clotho-show="'+a+'"></div>'),d=document.querySelector(b);d||(d=document.getElementById("clothoAppWidgets")),d=angular.element(d),d.append(k(c)(i))},s=function(a,b){var c=angular.element(document.querySelector('[clotho-show="'+a+'"]'));b.apply(null,c.remove())},t=function(a){m.info(a)},u=function(b){angular.isString(b.text)||(angular.isNumber(b.text)?b.text=parseInt(b.text):null===b.text?b.text="null":angular.isUndefined(b.text)?b.text="undefined":b.text===!0?b.text="true":b.text===!1&&(b.text="false"));var c={"class":"muted",from:"server",timestamp:Date.now().valueOf()};b=angular.extend({},c,b);var d={success:"success",warning:"warning",error:"danger",failure:"danger",normal:"success",muted:"muted",info:"info"};b.class=d[angular.lowercase(b.class)],a.trigger("activityLog",b)},v=function(b){a.trigger("serverAlert"),angular.isDefined(l)?i.$safeApply(l.serverAlert(b).result.then(function(a){m.log("dialog closed with result: "+a)})):f.alert(b)},w=function(){},x=function(b,c){a.trigger("revisions:"+b,c)},y=function(a){j.path("/trails/"+a)},z=function(c){if(m.log("(autocompleteDetail)",c),angular.isObject(c.command_object)&&c.command_object.function_id){var d=c.command_object.function_id;b.storeModel("detail_"+d,c),a.trigger("autocompleteDetail_"+d,c)}else m.warn("(autocompleteDetail)	Could not extract id from object (possibly malformed)")};return{collect:n,edit:o,changeUrl:p,broadcast:q,log:t,say:u,alert:v,display:r,hide:s,help:w,revisions:x,startTrail:y,autocompleteDetail:z}}]),angular.module("clotho.core").service("clothoLocalStorage",["$window","PubSub","Debug","$document",function(a,b,c,d){function e(){function d(a,c){b.trigger("update",a),b.trigger("update:"+a,angular.copy(c))}var e=new c("clothoLocalStorage","#88cc88"),f=a.localStorage,g=JSON,h="clotho_",i=function(){try{if(f.setItem("test","7"),"7"===f.getItem("test"))return f.removeItem("test"),!0}catch(a){}return!1};e.log("localStorage support? "+i());var j=function(){for(var a=!1,b=0,c=f.length;c>b;++b){var d=f.key(b);angular.isString(d)&&d.substring(0,h.length)==h&&(f.removeItem(d),--b,--c,a=!0)}return a},k=function(a,b){if(angular.isEmpty(a))return null;var c=f.getItem(h+a);return angular.isEmpty(c)?angular.isDefined(b)?b:null:angular.isObject(c)?c:g.parse(c)},l=function(a){if(angular.isEmpty(a))return!1;var b=f.getItem(h+a);return angular.isDefined(b)&&!angular.isEmpty(b)},m=function(a){return angular.isEmpty(a)?!1:(f.removeItem(h+a),!0)},n=function(a,b){return angular.isEmpty(a)?!1:angular.isEmpty(b)?!1:(b=angular.isString(b)?b:g.stringify(b),f.setItem(h+a,b),!0)},o=function(b){b||(b=a.event);var c=b.key.replace(h,"")||"",f=k(c);e.log("handle_storage_event for "+c),d(c,f)};return a.addEventListener?a.addEventListener("storage",o,!1):a.attachEvent("onstorage",o),{getPrefix:function(){return h},isSupported:i,clear:j,getItem:k,hasItem:l,removeItem:m,setItem:n}}return a.$clotho.$localStorage?a.$clotho.$localStorage:a.$clotho.$localStorage=e()}]),angular.module("clotho.core").service("Collector",["$window","clothoLocalStorage","PubSub","Debug",function(a,b,c,d){function e(){function a(a,b){c.trigger("update",a),c.trigger("update:"+a,angular.copy(b))}var e=new d("Collector","#55bb55"),f={},g=function(a,c){f[a]=c,b.setItem(a,c)},h=function(b,c,d){d||!angular.equals(j(b),c)?(e.log(b+" (saving)",f[b],c),g(b,c),a(b,c)):e.log(b+" (model unchanged)")},i=function(a){return angular.copy(j(a))},j=function(a){return"undefined"==typeof a?f:f[a]&&"undefined"!=typeof f[a]?f[a]:(f[a]=b.getItem(a))?f[a]:!1},k=function(a){return f[a]?(f[a]=null,b.removeItem(a),!0):!1},l=function(){b.clear(),f={},c.trigger("collector_reset")};return{collector:f,hasItem:b.hasItem,silentAddModel:g,storeModel:h,retrieveModel:i,retrieveRef:j,removeModel:k,clearStorage:l}}return a.$clotho.$collector?a.$clotho.$collector:a.$clotho.$collector=e()}]),angular.module("clotho.core").service("PubSub",["$window","$rootScope","$filter","Debug",function(a,b,c,d){function e(){function a(a){return a?"all"==a?Object.keys(k):a.split(l):[]}function e(a){return k.hasOwnProperty(a)}function f(a){return e(a)&&k[a].length>0}function g(a,b,c,d){return angular.isFunction(a)?{callback:a,ref:b||null,priority:parseInt(c)||100,once:1==d}:null}function h(a,b){if(b&&!angular.isEmpty(b)){k[a]||(k[a]=[]);var c=b.ref;return angular.isScope(c)&&c.$on("$destroy",function(){t(j(c))}),k[a].push(b),angular.once(function(){i(a,b)})}return angular.noop}function i(a,b){var c=angular.remove(k[a],function(a){return angular.equals(a,b)});return c.length>0}function j(a){return angular.isScope(a)?a.$id:a}var k={},l=/\s+/,m=new d("PubSub","#55cccc"),n=function(){m.log("LISTENERS:"),angular.forEach(k,function(a,b){m.log(b),m.table(k[b])})},o=function(d,e){e=angular.isUndefined(e)||angular.isEmpty(e)?null:[e],angular.forEach(a(d),function(a){m.log("Publish on "+a,e),f(a)&&angular.forEach(c("orderBy")(k[a],"priority"),function(c,d){b.$safeApply(function(){c.callback.apply(c.ref,e)}),1==c.once&&k[a].splice(d,1)})})},p=function(c){angular.forEach(a(c),function(a){m.log("Reject on "+a),angular.forEach(k[a],function(c,d){b.$safeApply(function(){c.callback.apply(c.ref,null)}),1==c.once&&k[a].splice(d,1)})})},q=function(b,c,d,e,f){d=d||null,f=1==f,f&&(c=angular.once(c));var i=[];return angular.forEach(a(b),function(a){i.push(h(a,g(c,d,e,f)))}),function(){angular.forEach(i,function(a){a()})}},r=function(a,b,c,d){q(a,b,c,d,!0)},s=function(a,b){var c=angular.remove(k[a],function(a){return angular.equals(a.callback,b)});return c.length>0},t=function(a){angular.forEach(k,function(b){angular.remove(b,function(b){return angular.equals(j(a),j(b.ref))})})},u=function(b){angular.forEach(a(b),function(a,b){k[b].length=0})};return{logListeners:n,trigger:o,on:q,once:r,off:s,destroy:t,reject:p,clear:u}}return a.$clotho.$pubsub?a.$clotho.$pubsub:a.$clotho.$pubsub=e()}]),angular.module("clotho.core").service("Socket",["$window","$q","$log","PubSub","ClientAPI","Debug",function(a,b,c,d,e,f){function g(){function b(a){return h?(a=angular.isObject(a)?JSON.stringify(a):a,j.log("sending data: "+a),void g.send(a)):(j.log("(not ready) queueing request: ",a),void i.push(a))}function c(){angular.forEach(i,function(a){b(a)}),i=[]}var g,h,i=[],j=new f("Socket","#5555bb");return g=a.$clotho.socket?a.$clotho.socket:a.$clotho.socket=new WebSocket("wss://"+window.location.host+window.location.pathname+"websocket"),1==g.readyState?(j.log("already exists, sending items in socket Queue..."),h=!0,c()):g.onopen=function(){j.log("opened, sending queued items..."),h=!0,c()},g.onerror=function(a){j.error("socket error",a)},g.onclose=function(){h=!1,e.say({"class":"error",text:"Socket Connection Closed",from:"client"})},g.onmessage=function(a){a=JSON.parse(a.data),j.log("received",a);var b=a.channel,c=a.requestId,f=angular.isUndefined(a.data),g=a.data;if(angular.isFunction(e[b]))e[b](g);else{var h=f?"reject":"trigger";c?d[h](b+":"+c,g):d[h](b,g)}},{state:function(){return g.readyState},emit:function(a,c,d){var e={channel:a,data:c};b(e),"function"==typeof d&&d(e)},send:b}}return a.$clotho.$socket?a.$clotho.$socket:a.$clotho.$socket=g()}]);