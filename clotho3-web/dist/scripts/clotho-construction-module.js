angular.module("clotho.construction",["clotho.foundation","clotho.dna"]),angular.module("clotho.construction").value("ConstructionReactions",{pcr:{reactionId:"clotho.functions.dna.pcr",clientReaction:"PCR.predict",readable:"PCR",template:"views/_construction/step/pcr.html"},ligate:{reactionId:"clotho.functions.dna.ligate",clientReaction:"PCR.ligate",readable:"Ligation",template:"views/_construction/step/ligate.html"},digest:{reactionId:"clotho.functions.dna.digest",clientReaction:"Digest.digest",readable:"Restriction Digest",template:"views/_construction/step/digest.html"},gelpurify:{reactionId:"clotho.functions.dna.gelPurify",clientReaction:"Digest.gelPurify",readable:"Gel Purify",template:"views/_construction/step/gelpurify.html"}}),angular.module("clotho.construction").service("ConstructionSimulator",["ConstructionReactions","$q","Debug","Clotho",function(a,b,c,d){function e(a,c){if(!_.isString(c))return b.when(c);if(!_.isEmpty(a.dictionary)){var e=a.dictionary[c];if(console.log("dictionary result "+c,e),!_.isUndefined(e))return b.when(e)}return d.query({name:c},{mute:!0}).then(function(a){return 1!=a.length&&i.log("ambiguous query! "+a.length+" results for "+c),a[0]})}function f(a,b){var c=_.flatten(b.input),d=_.map(c,function(b){return e(a,b)});return _.zipObject(c,d)}function g(a,b){function c(b){return _.map(b,function(b){return _.isString(b)?a.dictionary[b]:c(b)})}return c(b.input)}function h(b,c){var e=a[c.reaction],f=g(b,c);return d.run(e.reactionId,f).then(function(a){var b={};return b[c.output]=a,b})}var i=new c("ConstructionSimulator","#88bb88"),j="final",k=function(a){var c=_.assign({dictionary:{}},a);if(_.isEmpty(c.steps))return c;var d=b.when(),e=b.defer();return _.forEach(c.steps,function(a,e){console.warn("step "+e+" loop started"),d=d.then(function(){return console.warn("step "+e,c.dictionary,a.input,a.output),b.all(f(c,a))}).then(function(b){return console.warn("step "+e+" args resolved",b),_.forEach(b,function(a,b){(_.isArray(a)||_.isObject(a)&&_.isUndefined(c.dictionary[b]))&&(c.dictionary[b]=a)}),h(c,a)}).then(function(a){return console.warn("step "+e+" processed",a),b.when(_.assign(c.dictionary,a))})}),e.resolve(),e.promise.then(function(){return d}).then(function(){var a=_.last(c.steps).output;return a!=j&&(c.dictionary[j]=c.dictionary[a]),c})};return{process:k}}]),angular.module("clotho.construction").directive("constructionFile",["ConstructionSimulator",function(a){return{restrict:"A",templateUrl:"views/_construction/constructionFile.html",scope:{file:"=constructionFile"},link:function(b){b.$watch("file",function(c){a.process(c).then(function(a){b.computed=a})})}}}]),angular.module("clotho.construction").directive("constructionStep",["ConstructionReactions","$parse",function(a,b){return{restrict:"A",templateUrl:"views/_construction/constructionStep.html",link:function(c,d,e){c.$watch(function(){return b(e.constructionStep)(c)},function(b){angular.isNumber(b)&&(c.step=c.file.steps[b],c.reaction=a[c.step.reaction])})}}}]),angular.module("clotho.construction").directive("constructionStepInner",["$http","$compile","ConstructionReactions",function(a,b,c){return{restrict:"A",link:function(d,e,f){d.$watch(function(){return f.constructionStepInner},function(f){if(f){var g=c[f];!angular.isEmpty(g)&&a.get(g.template,{cache:!0}).then(function(a){e.html(b(a.data)(d))})}})}}}]);