angular.module("clotho.editor",["clotho.foundation","clotho.interface"]),angular.module("clotho.editor").directive("clothoEditor",["Clotho","$compile","$parse","$http","$templateCache","$filter","$q",function(a,b,c,d,e,f,g){return{restrict:"A",require:["ngModel","^form"],scope:{inputSharable:"=ngModel",editMode:"=?"},controller:["$scope","$element","$attrs",function(c,f,h){h.$set("novalidate","novalidate"),angular.isString(h.name)||h.$set("name","sharableEditor"),c.editMode=!!c.editMode,c.logScope=function(){console.log(c)},c.schema={},c.formDirty=!1,c._objBaseFields="views/_editor/_baseFields.html",c._formActions="views/_editor/_formActions.html",c.processInputSharable=function(b){c.sharable={},console.log(b),angular.isObject(b)&&!angular.isEmpty(b)?(console.log("sharable object passed"),c.id=b.id,c.sharable=b):angular.isString(b)?(console.log("passed a string, assuming a valid ID: "+b),c.id=b):(console.log("sharable must be an object or a string, you passed: ",b),c.id="",c.sharable={});var d=angular.isEmpty(c.sharable)&&""!=c.id?a.get(c.id):g.when(c.sharable);d.then(function(a){c.sharable=a,c.type=c.determineType(a),c.getPartialAndCompile(c.type,a)})},c.processInputSharable(c.inputSharable),c.determineType=function(a){function b(a,b){return-1!==a.indexOf(b,a.length-b.length)}if(angular.isUndefined(a)||angular.isEmpty(a))return"undefined";var c=angular.lowercase(a.schema);return b(c,"schema")?"schema":b(c,"function")?"function":"sharable"},c.getPartialAndCompile=function(a){switch(c.editMode=!1,angular.lowercase(a)){case"function":d.get("views/_editor/function.html",{cache:e}).success(function(a){var d=b(a)(c);f.html(d)});break;case"schema":d.get("views/_editor/schema.html",{cache:e}).success(function(a){var d=b(a)(c);f.html(d)});break;case"sharable":d.get("views/_editor/sharable.html",{cache:e}).then(function(a){var d=b(a.data)(c);f.html(d)});break;default:console.log("unknown type"),f.html('<p class="text-center">Please select an Object</p>')}}}],compile:function(){return{pre:function(){},post:function(b,d,e){b.form=c(e.name)(b),b.edit=function(){b.editMode=!0},b.reset=function(){b.form.$setPristine(),a.get(b.id).then(function(a){b.sharable=a})},b.save=function(){a.set(b.sharable),b.editMode=!1},b.discard=function(){b.reset(),b.editMode=!1},b.destroy=function(){a.destroy(b.sharable.id).then(function(){b.editMode=!1,b.sharable=null,b.id=null,b.compileEditor()})},a.listen("collector_reset",function(){b.processInputSharable()},b),a.watch(b.id,b.sharable,b),b.$watch("inputSharable",function(a){b.processInputSharable(a)})}}}}}]),angular.module("clotho.editor").controller("Editor_SharableCtrl",["$scope","$compile","Clotho",function(a,b,c){function d(){var b="";return angular.forEach(a.schema.fields,function(a){var c=a.type||"text";"?"==c&&"text"==a.type;var d,e=a.required?"required='required'":"",f='<div class="form-group"><label class="control-label" for="'+a.name+'">'+a.name+"</label>",g="</div>";switch(c){case"textarea":d='<textarea class="input-lg" id="'+a.name+'" name="'+a.name+'" '+e+' ng-model="sharable.'+a.name+'" ng-disabled="!editMode"></textarea>';break;case"select":var h="";angular.forEach(a.options,function(a){h=h+'<option value="'+a+'">'+a+"</option>"}),d='<select id="'+a.name+'" name="'+a.name+'" '+e+' ng-disabled="!editMode" ng-model="sharable.'+a.name+'">'+h+"</select>";break;case"sharable":default:d='<input type="'+c+'" class="input-lg" id="'+a.name+'" name="'+a.name+'" '+e+' ng-disabled="!editMode" ng-model="sharable.'+a.name+'" >'}b+=f+d+g}),b}a.$watch("sharable",function(e){console.log(e),c.get(e.schema).then(function(c){a.schema=c,a.schema_custom=c.custom;var e=angular.element(document).find("insert-fields").html(d());b(e.contents())(a)})})}]),angular.module("clotho.editor").controller("Editor_FunctionCtrl",["$scope","Clotho","$filter",function(a,b,c){a.langTypes=[{name:"JavaScript",value:"JAVASCRIPT"},{name:"Java",value:"JAVA"},{name:"Python",value:"PYTHON"},{name:"Groovy",value:"GROOVY"}],a.outputTypes=[{name:"Value",value:"VALUE"},{name:"Reference",value:"REFERENCE"}],a.simpleTypes={object:!0,string:!0,number:!0,"boolean":!0,array:!0},a.paramTypes=[{name:"object",type:"object",category:"Primitive",javaType:"java.util.HashMap",reference:!1},{name:"array",type:"array",category:"Primitive",javaType:"java.util.Arrays",reference:!1},{name:"string",type:"string",category:"Primitive",javaType:"java.lang.String",reference:!1},{name:"number",type:"number",category:"Primitive",javaType:"java.lang.Long",reference:!1},{name:"boolean",type:"boolean",category:"Primitive",javaType:"java.lang.Boolean",reference:!1}],b.query({schema:"Schema"}).then(function(b){angular.forEach(b,function(b){a.paramTypes.push(angular.extend(b,{category:"Schema"}))})}),a.clothoFunctions=[],b.query({schema:"Function"}).then(function(b){a.clothoFunctions=b}),a.addArg=function(){angular.isEmpty(a.sharable.args)&&(a.sharable.args=[]),a.sharable.args.push({type:"",name:""})},a.addDep=function(){angular.isEmpty(a.sharable.dependencies)&&(a.sharable.dependencies=[]),a.sharable.dependencies.push("")},a.addTest=function(){angular.isEmpty(a.sharable.tests)&&(a.sharable.tests=[]),a.sharable.tests.push({args:[],output:{value:"",type:""}})},a.testResults={},a.singleTest=function(c){var d={};d.id=a.sharable.id,d.args=angular.isEmpty(a.sharable.tests)?[]:a.sharable.tests[c].args,b.run(d.id,d.args).then(function(b){console.log(b,a.sharable.tests[c].output.value,b==a.sharable.tests[c].output.value),a.testResults[c]=b==a.sharable.tests[c].output.value})},a.runAllTests=function(){for(var b=0;b<a.sharable.tests.length;b++)a.singleTest(b)},a.resetTests=function(){a.testResults={}},a.querySchemaWrapper=function(a){return b.query({schema:a}).then(function(a){return c("limitTo")(a,10)})},a.testPopoverText=function(b){var d=a.sharable.tests[b].args;return d?c("json")(d):"Search for an object of type {{ param.type }}"},a.save=function(){a.resetTests(),a.$parent.save()},a.$watch("editMode",function(b){a.codemirrorEditorOptions.readOnly=b?!1:"nocursor"}),a.codemirrorEditorOptions={lineWrapping:!0,lineNumbers:!0,onLoad:function(b){a.$watch("sharable.language",function(){var c=a.sharable.language.toLowerCase();c="java"==c?"text/x-java":c,b.setOption("mode",c)}),b.on("beforeChange",function(){}),b.on("change",function(){a.resetTests()})}},a.resetTests()}]),angular.module("clotho.editor").controller("Editor_SchemaCtrl",["$scope","Clotho",function(a,b){a.schemas=[],b.query({schema:"Schema"}).then(function(b){a.schemas=b}),a.clothoFunctions=[],b.query({schema:"Function"}).then(function(b){a.clothoFunctions=b}),a.accessTypes=[{name:"Public",value:"PUBLIC"},{name:"Private",value:"PRIVATE"},{name:"Read Only",value:"READONLY"}],a.constraintTypes=[{name:"RegExp",value:"regex"},{name:"Not Null",value:"notnull"}],a.primitiveToJava={string:"java.lang.String",number:"java.lang.Long","boolean":"java.lang.Boolean",object:"java.util.HashMap",array:"java.util.List"},a.findSpacesRegExp=/\s/gi,a.parseField=function(b){a.simpleTypes[b.type]?(b.javaType=a.primitiveToJava[b.type],b.reference=!1):b.reference=!0},a.$watch("sharable.superClass",function(){a.getSuperClass()}),a.getSuperClass=function(){a.sharable.superClass&&b.get(a.sharable.superClass).then(function(b){a.superClassObj=b})},a.newMethod=function(){return""},a.addMethod=function(b){angular.isEmpty(a.sharable.methods)&&(a.sharable.methods=[]),a.sharable.methods.push(b)},a.addNewMethod=function(){angular.isEmpty(a.newMethodObj)||(a.addMethod(a.newMethodObj),a.newMethodObj=a.newMethod())},a.determineMethodName=function(b){return _.find(a.clothoFunctions,{id:b}).name},a.newField=function(){return{name:"",type:"",description:"",example:"",constraints:null,access:"PUBLIC"}},a.addField=function(){angular.isEmpty(a.sharable.fields)&&(a.sharable.fields=[]),a.sharable.fields.push(a.newField())},a.newConstraint=function(){return{type:"",value:""}},a.addConstraint=function(b){angular.isEmpty(a.sharable.fields[b].constraints)&&(a.sharable.fields[b].constraints=[]),a.sharable.fields[b].constraints.push(a.newConstraint())},a.save=function(){angular.forEach(a.sharable.fields,function(a){if(console.log(a),a.constraints){var b=a.constraints;a.constraints={},angular.forEach(b,function(b){a.constraints[b.type]=b.value})}else a.constraints=null}),console.log(a.sharable),a.$parent.save()}}]);