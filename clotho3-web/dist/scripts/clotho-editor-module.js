angular.module("clotho.editor",["clotho.foundation","clotho.interface"]),angular.module("clotho.editor").directive("clothoEditor",["Clotho","$compile","$parse","$http","$templateCache","$filter","$q","Debug","ClothoSchemas",function(a,b,c,d,e,f,g,h,i){var j=new h("Editor","#dd44dd"),k="views/_editor/_baseFields.html",l="views/_editor/_formActions.html";return{restrict:"A",require:"^form",scope:{sharable:"=",editMode:"=?",formHorizontal:"=?"},link:function(c,f,h,m){h.$set("novalidate","novalidate"),angular.isString(h.name)||h.$set("name","sharableEditor"),c.$watch("formHorizontal",function(a){f.toggleClass("form-horizontal",a)}),c._objBaseFields=k,c._formActions=l,c.removeField=function(a){j.warn("(DEPRECATED) - removing fields from sharables is not supported"),j.log("removing key "+a),delete c.sharable[a]};var n;c.processInputSharable=function(b){if(angular.isEmpty(b))return j.warn("sharable is undefined / empty"),void c.getPartialAndCompile();var d;if(c.sharable={},n=null,angular.isObject(b)&&!angular.isEmpty(b))j.log("sharable object passed"),d=g.when(b);else{if(!angular.isString(b))return j.warn("sharable must be an object or a string, you passed: ",b),void c.getPartialAndCompile(null);j.log("passed a string, assuming a valid ID: "+b),d=a.get(b)}d.then(function(a){n=a,c.getPartialAndCompile(i.determineInstanceType(a))})},c.getPartialAndCompile=function(a){return c.showJsonEditor=!1,angular.isEmpty(a)?void f.html('<p class="text-center">Please select an Object</p>'):void d.get(i.sharableTypes[a].editor_template_url,{cache:e}).success(function(d){c.sharable=n,c.panelClass=i.sharableTypes[a].class||"default";var e=b(d)(c);f.html(e)}).error(function(){j.error("Could not retrieve template for type "+a),f.html('<p class="text-center">Please select an Object</p>')})},c.isValidJson=function(a){var b=!0;try{angular.fromJson(a)}catch(c){b=!1}return b},c.edit=function(){c.editMode=!0},c.toggleJsonEdit=function(){c.showJsonEditor=!c.showJsonEditor},c.reset=function(){a.get(c.sharable.id).then(function(a){c.sharable=a,m.$setPristine()})},c.save=function(){c.isValidJson(c.sharable)?(a.set(c.sharable).then(function(a){c.sharable.id||(c.sharable.id=a)}),c.editMode=!1):a.alert("Your JSON is invalid... please fix it")},c.discard=function(){c.reset(),c.editMode=!1},c.destroy=function(){a.destroy(c.sharable.id).then(function(){c.editMode=!1,c.sharable=null,c.processInputSharable(null)})},a.listen("collector_reset",function(){c.processInputSharable(c.editable)},c);var o=angular.noop;c.$watch("sharable",function(b,d){!angular.isEmpty(b)&&(!d||angular.isString(b)&&b!=d||b.id&&b.id!=d.id)&&(j.log("sharable is different",b,d),o(),o=a.watch(b.id,function(a){c.sharable=a},c),c.processInputSharable(b))}),c.processInputSharable(c.sharable)}}}]),angular.module("clotho.editor").service("codemirrorLoader",["Clotho","$q",function(a,b){function c(a){var c=f[angular.lowercase(a)];return c?$clotho.extensions.mixin(c):(console.log("language not supported in codemirror: "+a),b.when())}function d(){return b.all([$clotho.extensions.mixin("bower_components/codemirror/lib/codemirror.js"),$clotho.extensions.css("bower_components/codemirror/lib/codemirror.css")])}var e="bower_components/codemirror/mode/",f={javascript:e+"javascript/javascript.js",css:e+"css/css.js",html:e+"htmlmixed/htmlmixed.js",python:e+"python/python.js",groovy:e+"groovy/groovy.js",java:e+"clike/clike.js",markdown:e+"markdown/markdown.js"};return{loadMain:d,loadLanguage:c}}]),angular.module("clotho.editor").directive("formField",["$parse",function(a){var b='<div class="form-group" ng-form ng-transclude></div>';return{restrict:"E",template:b,replace:!0,transclude:!0,require:["^form","^?clothoEditor"],controller:["$scope","$element","$attrs",function(){}],link:function(b,c,d,e){var f=e[0],g=(e[1],d.name),h=d.help,i=a(d.horizontal)(b),j=(d.removableField,!1),k=c.children();if(1!==k.length)throw"You must include the form input element as the single child of this directive, instead got "+c.html()+"generating:";var l=k.attr("id"),m=(k.prop("tagName"),k.attr("type")),n=/checkbox|radio|button/gi,o=/file|checkbox|radio/gi;l||(l="input"+Math.floor(1e7*Math.random()).toString(),k.attr("id",l)),o.test(m)||k.addClass("form-control");var p=angular.element('<label class="control-label" for="'+l+'">'+("radio"===m?k.val():g)+"</label>");if(n.test(m)){var q=angular.element('<div class="'+m+'"></div>');q.append(k),k=q}if(i){p.addClass("col-sm-3");var q=angular.element('<div class="col-sm-9"></div>');q.append(k)}c.append(q),g&&!j&&c.prepend(p),h&&c.append('<p class="help-block">'+h+"</p>"),b.$watch(function(){return f.$invalid},function(a){c.toggleClass("has-error",a)})}}}]),angular.module("clotho.interface").directive("functionCodeDrop",["$upload","$window","$timeout",function(a,b,c){return{restrict:"A",templateUrl:"../../../views/_interface/codeDrop.html",scope:{updateOnRead:"=",showDrop:"@",showBrowser:"@"},controller:["$scope","$element","$attrs",function(a){function d(b,d){b.readAsText(d),b.onload=function(b){c(function(){a.updateOnRead=b.target.result})}}a.uploadRightAway=!1,a.selectedFiles=[],a.inputFiles=[],a.onFileSelect=function(c){a.selectedFiles=c;for(var e=0;e<c.length;e++){var f=c[e];if(b.FileReader&&f.type.indexOf("text")>-1){var g=new FileReader;d(g,c[e])}}}}],link:function(){}}}]),angular.module("clotho.editor").directive("formFieldEnumeration",["Clotho","ClothoSchemas","$q","$compile",function(a,b,c,d){function e(a){var c=angular.element("<div ng-form>");return angular.forEach(a,function(a){var d=angular.element("<form-field>");d.attr({name:a.name,horizontal:"formHorizontal"});var e,f=b.formTypeMap[a.type]||!1;f?f.input?(e=angular.element("<input>"),e.attr(f.input),e.attr({"ng-model":"sharable."+a.name})):(e=angular.element("<textarea>"),e.attr({"json-edit":"sharable."+a.name,rows:3})):(e=angular.element("<textarea>"),e.attr({"json-edit":"sharable."+a.name,rows:1,placeholder:"Edit JSON directly, use quotes for strings"})),e.attr({placeholder:a.description}),a.required&&e.attr({"ng-required":!0}),d.append(e),c.append(d)}),c}return{restrict:"A",scope:{fields:"=?",schema:"=?",sharable:"=?",stripBasicFields:"@?"},controller:["$scope","$element","$attrs",function(){}],link:function(c,f,g){function h(){f.empty(),f.prepend(j),f.prepend(i),f.prepend(k)}if(angular.isUndefined(g.fields)&&angular.isUndefined(g.sharable))return void f.html("no schema information passed");c.formHorizontal=c.$parent.formHorizontal;var i=angular.element("<div>"),j=angular.element("<div>"),k=angular.element("<div>");c.$watch("fields",function(a){a&&k.replaceWith(d(e(a))(c))},!0),c.$watch(function(){return _.keys(c.sharable)},function(){c.sharable&&c.sharable.schema?a.get(c.sharable.schema).then(function(a){b.downloadSchemaDependencies(a).then(function(a){var f=_.pluck(a.fields,"name"),g=_.keys(c.sharable),k=_.difference(g,f),l=_.map(k,function(a){return{name:a}});c.stripBasicFields&&(_.remove(a.fields,function(a){return angular.isDefined(b.sharableBasicFields[a.name])}),_.remove(l,function(a){return angular.isDefined(b.sharableBasicFields[a.name])})),i=d(e(a.fields))(c),j=d(e(l))(c),h()})}):i=angular.element('<div class="alert">Sharable has no schema...</div>')},!0)}}}]),angular.module("clotho.editor").directive("formFieldInput",["ClothoSchemas","$compile","$parse",function(a,b,c){return{restrict:"A",link:function(d,e,f){function g(c){var g,h=a.formTypeMap[c]||!1;h?h.input?(g=angular.element("<input>"),g.attr(h.input),g.attr({"ng-model":f.formFieldModel})):(g=angular.element("<textarea>"),g.attr({"json-edit":f.formFieldModel,rows:3})):(g=angular.element("<input>"),g.attr({type:"text","ng-model":f.formFieldModel})),angular.forEach(f,function(a,b){"class"==b?g.addClass(a):"$"==b.charAt(0)||g.attr(b)||g.attr(f.$attr[b],a)}),e.attr("type",null),e.attr("ng-model",null),e.attr("json-edit",null),e.replaceWith(b(g)(d))}var h;h=d.$watch(function(){return c(f.formFieldType)(d)},function(a,b){a!=b&&(g(a),h())})}}}]),angular.module("clotho.editor").directive("jsonEdit",function(){return{restrict:"A",require:"ngModel",template:'<textarea ng-model="jsonEditing"></textarea>',replace:!0,scope:{model:"=jsonEdit"},link:function(a,b,c,d){function e(a){try{return angular.fromJson(a)}catch(b){return j(),a}}function f(a){return angular.toJson(a,!0)}function g(b){a.jsonEditing=f(b)}function h(b){a.model=e(b)}function i(){d.$setValidity("json",!0)}function j(){d.$setValidity("json",!1)}function k(a){var b=!0;try{angular.fromJson(a)}catch(c){b=!1}return b}g(a.model),a.$watch("jsonEditing",function(a,b){a!=b&&(k(a)?(i(),h(a)):j())},!0),a.$watch("model",function(a,b){a!=b&&g(a)},!0)}}}),angular.module("clotho.editor").controller("Editor_SharableCtrl",["$scope",function(a){a.addNewField=function(){a.newFieldKey&&a.newFieldVal&&(a.sharable[a.newFieldKey]=a.newFieldVal,a.newFieldKey=null,a.newFieldVal=null)}}]),angular.module("clotho.editor").controller("Editor_FunctionCtrl",["$scope","Clotho","$filter","codemirrorLoader","ClothoSchemas","$timeout",function(a,b,c,d,e,f){a.langTypes=[{name:"JavaScript",value:"JAVASCRIPT"},{name:"Java",value:"JAVA"},{name:"Python",value:"PYTHON"},{name:"Groovy",value:"GROOVY"}],a.outputTypes=[{name:"Value",value:"VALUE"},{name:"Reference",value:"REFERENCE"}],a.simpleTypes={object:!0,string:!0,number:!0,"boolean":!0,array:!0},a.paramTypes=[],angular.forEach(e.primitiveToJava,function(b,c){a.paramTypes.push({id:c,name:c,type:c,category:"Primitive",reference:!1})}),e.retrievedSchemas.then(function(b){angular.forEach(b,function(b){a.paramTypes.push(angular.extend(b,{category:"Schema"}))})}),a.clothoFunctions=[],b.query(e.sharableTypes.Function.schema).then(function(b){a.clothoFunctions=b}),a.addArg=function(){angular.isEmpty(a.sharable.args)&&(a.sharable.args=[]),a.sharable.args.push({type:"",name:""})},a.addDep=function(){angular.isEmpty(a.sharable.dependencies)&&(a.sharable.dependencies=[]),""!=a.newDependencyModel&&a.sharable.dependencies.push(a.newDependencyModel)},a.addTest=function(){angular.isEmpty(a.sharable.tests)&&(a.sharable.tests=[]),a.sharable.tests.push({args:[],output:{value:"",type:""}})},a.testResults={},a.singleTest=function(c){var d={};d.id=a.sharable.id,d.args=angular.isEmpty(a.sharable.tests)?[]:a.sharable.tests[c].args,b.run(d.id,d.args).then(function(b){console.log(b,a.sharable.tests[c].output.value,b==a.sharable.tests[c].output.value),a.testResults[c]=b==a.sharable.tests[c].output.value})},a.runAllTests=function(){for(var b=0;b<a.sharable.tests.length;b++)a.singleTest(b)},a.resetTests=function(){a.testResults={}},a.querySchemaWrapper=function(a,c){return b.query({schema:a,name:c},{maxResults:10}).then(function(a){return a})},a.testPopoverText=function(b){var d=a.sharable.tests[b].args;return d?c("json")(d):"Search for an object of type {{ param.type }}"},a.save=function(){a.resetTests(),a.$parent.save()},a.$watch("editMode",function(b){a.codemirrorEditorOptions.readOnly=b?!1:"nocursor",a.resetTests()}),a.codemirrorEditorOptions={lineWrapping:!0,lineNumbers:!0,onLoad:function(b){a.$watch("sharable.language",function(a){if(a){var c=a.toLowerCase();d.loadLanguage(c).then(function(){c="java"==c?"text/x-java":c,f(function(){b.setOption("mode",c)},500)})}}),b.on("beforeChange",function(){}),b.on("change",function(){})}},a.resetTests()}]),angular.module("clotho.editor").controller("Editor_TrailCtrl",function(){}),angular.module("clotho.editor").controller("Editor_SchemaCtrl",["$scope","Clotho","ClothoSchemas",function(a,b,c){a.schemas=[],c.retrievedSchemas.then(function(b){a.schemas=b}),a.clothoFunctionWrap=function(a){return b.query({schema:c.sharableTypes.Function.schema,name:a},{mute:!0}).then(function(a){return a||[]})},a.accessTypes=c.accessTypes,a.constraintTypes=c.constraintTypes,a.primitiveToJava=c.primitiveToJava,a.findSpacesRegExp=/\s/gi,a.parseField=function(b){b.reference=!angular.isEmpty(a.simpleTypes[b.type])},a.paramTypes=[{name:"object",type:"object",category:"Primitive",reference:!1},{name:"array",type:"array",category:"Primitive",reference:!1},{name:"string",type:"string",category:"Primitive",reference:!1},{name:"number",type:"number",category:"Primitive",reference:!1},{name:"boolean",type:"boolean",category:"Primitive",reference:!1}],c.retrievedSchemas.then(function(b){angular.forEach(b,function(b){a.paramTypes.push(angular.extend(b,{category:"Schema"}))})}),a.$watch("sharable.superClass",function(b){b&&a.getSuperClass()}),a.getSuperClass=function(){a.sharable.superClass&&b.get(a.sharable.superClass).then(function(b){a.superClassObj=b})},a.newMethod=function(){return""},a.addMethod=function(b){angular.isEmpty(a.sharable.methods)&&(a.sharable.methods=[]),a.sharable.methods.push(b)},a.addNewMethod=function(){angular.isEmpty(a.newMethodObj)||(a.addMethod(a.newMethodObj),a.newMethodObj=a.newMethod())},a.determineMethodName=function(b){return _.find(a.clothoFunctions,{id:b}).name},a.newField=function(){return{name:"",type:"",description:"",example:"",constraints:null,access:"PUBLIC"}},a.addField=function(){angular.isEmpty(a.sharable.fields)&&(a.sharable.fields=[]),a.sharable.fields.push(a.newField())},a.newConstraint=function(){return{type:"",value:""}},a.addConstraint=function(b){angular.isEmpty(a.sharable.fields[b].constraints)&&(a.sharable.fields[b].constraints=[]),a.sharable.fields[b].constraints.push(a.newConstraint())},a.save=function(){angular.forEach(a.sharable.fields,function(a){if(console.log(a),a.constraints){var b=a.constraints;a.constraints={},angular.forEach(b,function(b){a.constraints[b.type]=b.value})}else a.constraints=null}),console.log(a.sharable),a.$parent.save()}}]);