angular.module("clotho.trails",["clotho.foundation","clotho.interface"]),angular.module("clotho.trails").service("Trails",["Clotho","$q","$location",function(a,b,c){var d=function(c){var d=c.dependencies||null,e=b.defer();if(!d&&!c.mixin)return e.resolve(c),e.promise;var f=[],g=[];return d&&angular.forEach(d,function(b){g.push(a.get(b))}),i(c.dependencies).then(function(){return b.all(g)}).then(function(a){d={},angular.forEach(a,function(a){d[a.id]=a}),angular.forEach(c.contents,function(a){if(angular.isUndefined(a.transclude))f.push(a);else{var b=a.transclude.id,c=a.transclude.chapters;if("all"==c||"undefined"==typeof c)for(var e=0;e<d[b].contents.length;e++)f.push(d[b].contents[e]);else{var g=c.split("-");if(1==g.length)f.push(d[b].contents[g[0]]);else{if(g[0]>g[1])return"wrong format - start must be smaller than end";for(var e=g[0];e<=g[1];e++)f.push(d[b].contents[e])}}}}),c.contents=f,e.resolve(c)}),e.promise},e=function(a,b){var c=angular.isString(b)?b.split("-"):[0,0],d=a.contents[c[0]].pages[c[1]];return d},f=function(a,b){b=angular.isUndefined(b)?b.split("-"):[0,-1];var c;if("undefined"!=typeof a.contents[b[0]].pages[+b[1]+1])c=b[0]+"-"+(+b[1]+1);else{if("undefined"==typeof a.contents[+b[0]+1].pages)return;c=+b[0]+1+"-0"}return c},g=function(a,b){if("0-0"!=b){b="undefined"!=typeof b?b.split("-"):[0,1];var c;return c="undefined"!=typeof a.contents[b[0]].pages[+b[1]-1]?b[0]+"-"+(+b[1]-1):+b[0]-1+"-"+(a.contents[+b[0]-1].pages.length-1)}},h=function(a){a&&angular.isString(a)&&(a.indexOf("-")<0&&(a+="-0"),c.search("position",a))},i=function(a){return angular.isEmpty(a)?b.when(angular.noop):b.all([$clotho.extensions.css(a.css),$clotho.extensions.mixin(a.mixin),$clotho.extensions.script(a.script)]).then(function(){return function(){$clotho.extensions.script(a.onload)}})},j={book:"glyphicon glyphicon-book",exercise:"glyphicon glyphicon-edit",eye:"glyphicon glyphicon-eye-open",info:"glyphicon glyphicon-info-sign",list:"glyphicon glyphicon-list-alt",picture:"glyphicon glyphicon-picture",quiz:"glyphicon glyphicon-pencil",schedule:"glyphicon glyphicon-calendar",slides:"glyphicon glyphicon-th-large",syllabus:"glyphicon glyphicon-list-alt",video:"glyphicon glyphicon-film",undefined:"glyphicon glyphicon-file"},k=function(a){return a=a||"undefined",j[a]||j.undefined},l=function(a){console.log("favorite trail with id: "+a)};return{compile:d,extractPage:e,calcNextPage:f,calcPrevPage:g,activate:h,mapIcon:k,share:a.share,favorite:l,downloadDependencies:i}}]),angular.module("clotho.trails").directive("trailQuiz",["$http","$templateCache","$compile","Clotho","$interpolate","$q","$sce",function(a,b,c,d,e,f,g){var h=function(a,b,c){return d.run("gradeQuiz",[a,b,c])};return{restrict:"EA",require:"ngModel",scope:{quiz:"=ngModel",gradeCallback:"=?",advance:"&?"},compile:function(){return{pre:function(d,f){angular.extend(d,d.quiz),d.interpolatedQuestion=e(d.quiz.question)(d),d.parsedQuestion=function(){return g.trustAsHtml("<h5>"+d.quiz.question+"</h5>")},a.get("views/_trails/quiz/"+d.quiz.type+"-partial.html",{cache:b}).success(function(a){f.html(c('<div class="quiz">'+a+"</div>")(d))}).error(function(){f.html("<p>Template could not be found...</p>"+JSON.stringify(d.quiz))})},post:function(a){a.createEmptyAnswer=function(b,c){c="undefined"!=typeof c?c:!1,a.quiz.answer=new Array(b.options.length);for(var d=0;d<a.quiz.answer.length;d++)a.quiz.answer[d]=c},a.answerUndefined=function(a){return"undefined"==typeof a.answer||""===a.answer},a.submitQuestion=function(b){h(b.questionValue,b.answer,b.answerGenerator).then(function(b){console.log("gradeQuiz result: "+b),a.quiz.submitted=!0,a.quiz.response={},a.quiz.response.result=b,angular.isDefined(a.gradeCallback)&&a.gradeCallback(b)})},a.$watch("quiz.questionValue",function(){a.interpolatedQuestion=e(a.quiz.question)(a)}),a.resetQuiz=function(){a.quiz.submitted=!1,a.quiz.response=null,a.quiz.answer=null},a.retryQuiz=function(){if(a.quiz.retry){var b={},c=f.defer();return angular.forEach(a.quiz.retry,function(a,c){b[c]=d.submit(a).then(function(a){return a})}),f.all(b).then(function(b){angular.extend(a.quiz,b),angular.extend(a,a.quiz),a.resetQuiz(),console.log(a),c.resolve()}),c.promise}}}}}}}]),angular.module("clotho.trails").directive("youtube",["Trails","Youtube","$compile","$timeout","$http",function(a,b,c,d,e){return{restrict:"EA",replace:!0,scope:{videoId:"@youtube",params:"=?",autoplay:"@?",startMini:"@?",onComplete:"&?",onPlay:"&?",onPause:"&?"},link:function(a,d){function f(){b.apiPromise.then(function(b){a.player=new b.Player(d[0],a.params),angular.element(a.player.a).addClass("youtubePlayer")})}var g={width:700,height:525,border:0,autoplay:!1,mini:!1,videoId:a.videoId,playerVars:{autoplay:a.autoplay||a.startMini?1:0,autohide:1,rel:0},events:{}};a.params=angular.extend(g,a.params),a.params.videoId&&(a.autoplay=angular.isDefined(a.autoplay)?a.autoplay:a.params.autoplay,a.startMini=angular.isDefined(a.startMini)?a.startMini:a.params.mini,a.params.events.onStateChange=function(b){0==b.data?a.$apply(a.onComplete()):1==b.data?a.$apply(a.onPlay()):2==b.data&&a.$apply(a.onPause())},a.convertToPlayer=function(){f()},a.startMini&&"false"!=a.startMini?(a.miniThumb=b.videoThumbnail(a.videoId,"mqdefault"),b.videoInfo(a.videoId).then(function(b){a.miniInfo=b.data,a.miniInfo.durationFormatted=Math.floor(a.miniInfo.duration/60)+":"+(a.miniInfo.duration%60<10?"0":"")+a.miniInfo.duration%60}),e.get("views/_trails/youtubeThumbnail.html").success(function(b){d.html(c(b)(a))}).error(function(){})):(d.html('<div class="youtubeLoading" width="'+a.params.width+'" height="'+a.params.height+'"></div>'),f()),a.$watch("videoId",function(b,c){b!=c&&(a.params.videoId=b,f())}))}}}]),angular.module("clotho.trails").service("Youtube",["$http","$rootScope","$q","$timeout","$window",function(a,b,c,d,e){var f="AIzaSyBbk4x1xscVvwBaT0Liu8dd-G7qoDeiD30",g="https://www.googleapis.com/youtube/v3",h=c.defer();e.onYouTubeIframeAPIReady=function(){h.resolve(YT)},$clotho.extensions.script("//www.youtube.com/iframe_api");var i=function(a){var b=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return a.match(b)||a.match(/((\w|-){11})/)?RegExp.$1:!1},j=function(a,b){return b=b||"default","https://img.youtube.com/vi/"+a+"/"+b+".jpg"},k=function(b){return a.get(g+"/search",{params:{key:f,type:"video",maxResults:"15",part:"id, snippet",fields:"items/id,items/snippet/title,items/snippet/description,items/snippet/thumbnails/default,items/snippet/channelTitle",q:b}}).then(function(a){return a})},l=function(b){return a.get("https://gdata.youtube.com/feeds/api/videos/"+b+"?&alt=json").then(function(a){return a.data})},m=function(b){return a.get("https://www.googleapis.com/youtube/v3/playlists",{params:{key:f,part:"id, snippet, status, contentDetails",id:b}}).then(function(a){return a.data.items[0]})},n=function(b){return a.get(g+"/playlistItems",{params:{key:f,maxResults:"50",part:"id, snippet, status, contentDetails",playlistId:b}}).then(function(a){return a.data.items})};return{apiPromise:h.promise,extract:i,videoSearch:k,videoThumbnail:j,videoInfo:l,playlistInfo:m,playlistItems:n}}]),angular.module("clotho.trails").directive("trailPage",["$timeout","$q","$controller","hotkeys","Trails",function(a,b,c,d,e){return{restrict:"A",templateUrl:"views/_trails/trailPage.html",scope:{page:"=trailPage",next:"=",prev:"="},link:function(b){function c(){b.helpModalOpen=!b.helpModalOpen}b.helpModalOpen=!1,b.$watch("page",function(a){angular.isEmpty(a)||b.createPage()}),b.createPage=function(){angular.isDefined(b.page.dictionary)&&angular.extend(b,b.page.dictionary),e.downloadDependencies(b.page.dependencies).then(function(e){b.pageComponents=b.page.contents,b.page.help&&d.add("h","Toggle Page Help",c,!1),a(function(){e()})})}}}}]),angular.module("clotho.trails").directive("trailPageComponent",["$compile","$q","$timeout","$http","$templateCache","Youtube",function(a,b,c,d,e,f){return{restrict:"EA",scope:!1,compile:function(){return{pre:function(c,d){var e={};e.hint=function(a){if(!a||!angular.isObject(a))return b.when();var c='<div class="pull-right" hint-button="'+a+'"></div>';return b.when(c)},e.text=function(a){return a?b.when("<div>"+a+"</div>"):b.when()},e.markdown=function(a){return a?b.when("<ui-markdown>"+a+"</ui-markdown>"):b.when()},e.wiki=function(a){return a?b.when("<wiki>"+a+"</wiki>"):b.when()},e.video=function(a){if(!a)return b.when();var d=f.extract(angular.isString(a)?a:a.id);c.videoParams=a.params?a.params:{},c.videoParams.autoplay=angular.isDefined(a.autoplay)?a.autoplay:!1,c.videoParams.mini=angular.isDefined(a.mini)?a.mini:!1;var e='<div><div youtube="'+d+'" params="videoParams"></div></div>';return b.when(e)},e.template=function(a){return a&&angular.isString(a)?(console.log(a),b.when("<div ng-include=\"'"+a+"'\"></div>")):b.when()},e.quiz=function(a){if(!a||!angular.isObject(a))return b.when();if(c.quiz=angular.copy(a),c.quiz.dictionary){var d=angular.copy(c.quiz.dictionary);delete c.quiz.dictionary,angular.extend(c.quiz,d)}c.gradeCallback=function(a){console.log("quiz grade callback result: "+a)};var e='<div trail-quiz ng-model="quiz" grade-callback="gradeCallback" advance="next()"></div>';return b.when(e)},e.error=function(a){return b.when("<div>"+a+"</div>")};var g=function(a,b){return b&&angular.isString(b)?e[b]?e[b](a):e.error():void console.log("no type passed")};c.createPageComponent=function(){return g(c.componentParams,c.componentType).then(function(e){return b.when(d.html(a(e)(c)))})}},post:function(a,b,c){a.$watch(c.trailPageComponent,function(b,c){c&&(a.component=c,a.componentType=a.component.type,a.componentParams=a.component.params,a.createPageComponent())})}}}}}]),angular.module("clotho.trails").directive("trailContents",["Trails",function(a){return{restrict:"A",replace:!0,templateUrl:"views/_trails/trailContents.html",scope:{trail:"=trailContents"},link:function(b){b.activate=a.activate,b.mapIcon=a.mapIcon}}}]),angular.module("clotho.trails").directive("trailInstructor",["Clotho",function(a){var b="images/assets/defaultAvatar.jpg";return{restrict:"A",replace:!0,templateUrl:"views/_trails/trailInstructor.html",scope:{instructorId:"=trailInstructor"},link:function(c){c.$watch("instructorId",function(d){a.get(d).then(function(a){c.instructor=a,c.instructorIcon=a.icon||b})})}}}]),angular.module("clotho.trails").directive("trailMaterial",["Trails",function(a){return{restrict:"A",replace:!0,templateUrl:"views/_trails/trailMaterial.html",scope:{material:"=trailMaterial"},link:function(b){b.mapIcon=a.mapIcon}}}]),angular.module("clotho.trails").directive("trailHeader",function(){var a="images/trails/trails_logo.png";return{restrict:"A",replace:!0,templateUrl:"views/_trails/trailHeader.html",scope:{trail:"=trailHeader"},link:function(b){b.defaultTrailIcon=a}}});